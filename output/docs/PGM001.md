# PGM001 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM001 |
| 프로그램 목적 | 전일 생산라인별 실적 트랜잭션을 순차적으로 읽어 일일 생산수량을 집계하고, 집계 결과를 요약 파일과 DB2 테이블에 반영하는 일일 생산실적 집계 배치 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | PROD-TRANS-FILE (PRODTRAN) — 생산실적 트랜잭션 VSAM KSDS 파일 |
| 주요 출력 | DAILY-SUMMARY-FILE (DLYSMRY) — 일일 생산집계 요약 순차 파일, TB_DAILY_PROD DB2 테이블 |

## 2. 데이터 흐름

### 입력 데이터
- **PROD-TRANS-FILE (PRODTRAN)**: VSAM KSDS(Indexed) 파일. 키는 공장코드(4)+라인코드(10)+생산일자(8)+일련번호(5)로 구성. COPYBOOK `CPYTRANS`의 레이아웃을 따름. 생산라인별 개별 생산실적 트랜잭션 보유.
- **DCLTBPROD**: DB2 테이블 `TB_DAILY_PROD`의 DCLGEN (SELECT용은 아니며 UPDATE 시 호스트 변수 참조용)

### 출력 데이터
- **DAILY-SUMMARY-FILE (DLYSMRY)**: 순차 파일. COPYBOOK `CPYSMRY` 레이아웃. 집계된 일일 생산요약 레코드 1건 기록.
- **TB_DAILY_PROD**: DB2 테이블. 당일 일자 기준 행에 총수량, 총건수, 오류건수를 UPDATE.

### 사용 COPYBOOK
- **CPYTRANS**: 생산실적 트랜잭션 레코드 구조 (입력 파일 레이아웃). 공장/라인/일자/일련번호 키 + 제품코드, 수량(COMP-3), 단위, 작업자, 교대, 상태 등 포함.
- **CPYSMRY**: 일일 생산집계 요약 레코드 구조 (출력 파일 레이아웃). 공장/일자 키 + 총수량(COMP-3), 총건수, 오류건수, 처리시간, 상태코드 포함.
- **SQLCA**: DB2 SQL 통신 영역 (SQLCODE 등 SQL 실행 결과 확인용)
- **DCLTBPROD**: TB_DAILY_PROD 테이블 DCLGEN (호스트 변수 선언)

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 처리)
- **목적**: 프로그램 전체 실행 흐름을 제어하는 최상위 단락
- **처리 흐름**:
  1. 초기화 수행 (파일 열기, 첫 레코드 읽기)
  2. 파일 끝(EOF)에 도달할 때까지 트랜잭션 레코드를 반복 처리
  3. 집계 결과를 요약 파일에 기록
  4. DB2 테이블에 집계 결과 반영
  5. 종료 처리 (파일 닫기, 완료 메시지 출력)

### 1000-INITIALIZE (초기화)
- **목적**: 입출력 파일을 열고 정상 오픈 여부를 검증
- **처리 흐름**:
  1. PROD-TRANS-FILE을 INPUT으로 OPEN
  2. DAILY-SUMMARY-FILE을 OUTPUT으로 OPEN
  3. 파일 상태 코드가 '00'이 아니면 비정상 종료 처리
  4. 정상이면 첫 번째 레코드 읽기 수행
- **에러 처리**: WS-FILE-STATUS ≠ '00'이면 오류 메시지 출력 후 9900-ABNORMAL-END로 분기하여 프로그램 강제 종료

### 1100-READ-FIRST-RECORD (최초 레코드 읽기)
- **목적**: 반복 처리 진입 전 첫 번째 트랜잭션 레코드를 미리 읽기 (priming read 패턴)
- **처리 흐름**: PROD-TRANS-FILE에서 1건 READ. 파일이 비어있으면 EOF 플래그 설정.

### 2000-PROCESS-RECORDS (레코드별 집계 처리)
- **목적**: 개별 생산실적 트랜잭션을 읽으며 수량을 누적 집계하고, 비정상 데이터를 분류
- **처리 흐름**:
  1. 현재 레코드의 생산수량(PT-QTY)을 평가
  2. 수량에 따라 분기 처리 수행
  3. 다음 레코드 읽기 (EOF이면 반복 종료)
- **조건 분기** (EVALUATE):
  - **PT-QTY > 0** (정상 생산): 생산수량을 라인별 총수량(WS-LINE-TOTAL)에 누적하고, 일일 처리건수(WS-DAILY-COUNT) 1 증가
  - **PT-QTY = 0** (수량 미입력): 오류건수(WS-ERROR-COUNT)만 1 증가. 별도 로깅 없이 오류 카운트에만 반영.
  - **PT-QTY < 0** (음수/비정상): 외부 에러 로깅 프로그램 'ERRLOG'를 호출하여 해당 라인코드와 수량을 전달하고, 오류건수 1 증가
- **호출 서브프로그램**: `ERRLOG` — 음수 수량 등 비정상 데이터 발생 시 라인코드(PT-LINE-CD)와 수량(PT-QTY)을 전달하여 에러 로그를 기록

### 3000-WRITE-SUMMARY (집계 결과 파일 기록)
- **목적**: 누적된 집계 값을 일일 요약 파일에 1건의 레코드로 기록
- **처리 흐름**:
  1. 총생산수량(WS-LINE-TOTAL) → DS-TOTAL-QTY
  2. 총처리건수(WS-DAILY-COUNT) → DS-TOTAL-COUNT
  3. 총오류건수(WS-ERROR-COUNT) → DS-ERROR-COUNT
  4. DAILY-SUMMARY-REC 1건 WRITE
- **특이사항**: DS-PLANT-CD, DS-PROD-DATE, DS-PROCESS-TIME, DS-STATUS-CD 등 요약 레코드의 키와 부가 필드를 설정하지 않고 WRITE함 (리스크 항목 참조)

### 4000-UPDATE-DB2 (DB2 테이블 갱신)
- **목적**: 집계 결과를 DB2의 일일 생산실적 테이블에도 반영하여 온라인 조회 시스템과 데이터를 동기화
- **처리 흐름**:
  1. TB_DAILY_PROD 테이블에서 PROD_DATE = 당일(CURRENT DATE)인 행의 TOTAL_QTY, TOTAL_COUNT, ERROR_COUNT를 호스트 변수 값으로 UPDATE
  2. SQLCODE 확인
- **조건 분기**: SQLCODE ≠ 0이면 SQL 에러 처리 프로그램 'SQLERR'를 호출
- **호출 서브프로그램**: `SQLERR` — SQLCODE를 전달하여 SQL 에러 로깅 처리
- **비즈니스 관점**: 배치 집계 결과를 DB2에 반영하여 온라인 화면(MES 대시보드 등)에서 실시간 일일 생산현황 조회가 가능하도록 함

### 9000-FINALIZE (정상 종료)
- **목적**: 모든 파일을 닫고 처리 완료 메시지를 출력
- **처리 흐름**:
  1. PROD-TRANS-FILE CLOSE
  2. DAILY-SUMMARY-FILE CLOSE
  3. 처리 건수와 함께 완료 메시지 DISPLAY

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오픈 실패 등 치명적 오류 시 즉시 프로그램을 중단
- **처리 흐름**:
  1. 파일 상태 코드와 함께 ABEND 메시지 DISPLAY
  2. 'ABNDPGM' 서브프로그램 호출 (시스템 비정상 종료 처리)
  3. STOP RUN으로 프로그램 종료
- **호출 서브프로그램**: `ABNDPGM` — 파일 상태 코드를 전달하여 시스템 운영팀 통보 등 비정상 종료 후속 처리 수행

## 4. 비즈니스 규칙 요약

1. **정상 생산 집계**: 생산수량(PT-QTY) > 0인 트랜잭션만 총수량에 누적하고 정상 처리건수로 카운트
2. **수량 미입력 오류**: 생산수량이 정확히 0인 경우 오류건수만 증가시키되, 총수량에는 반영하지 않음 (별도 로깅 없음)
3. **비정상 수량 처리**: 생산수량이 음수인 경우 ERRLOG 프로그램으로 에러를 기록하고, 오류건수에 반영. 총수량에는 미반영.
4. **이중 저장**: 집계 결과는 순차 파일(DLYSMRY)과 DB2 테이블(TB_DAILY_PROD) 양쪽에 기록하여 배치 보고서와 온라인 조회 모두 지원
5. **당일 기준 갱신**: DB2 UPDATE는 CURRENT DATE 기준으로 수행하여 배치 실행일의 데이터만 갱신
6. **파일 오픈 실패 시 즉시 중단**: 입출력 파일을 열 수 없으면 후속 처리 없이 비정상 종료

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **생산관리** — 생산라인별 일일 실적 집계, 생산수량 누적, 생산보고서 생성. 품질관리 일부 관련(불량/오류 분류 로직). |
| 모더나이제이션 시 주의사항 | ① COMP-3(패킹 십진수) 데이터 타입 변환 필요 (PT-QTY, DS-TOTAL-QTY). ② ERRLOG, SQLERR, ABNDPGM 등 외부 서브프로그램 호출 체인 파악 필수. ③ DB2 UPDATE의 CURRENT DATE 의존성 — 배치 실행 시점과 실제 생산일자 불일치 가능성 검토. ④ 파일 기반 + DB2 이중 기록 아키텍처를 단일 데이터 저장소로 통합 검토. |

## 6. 특이사항/리스크

- **요약 레코드 키 미설정 (심각)**: 3000-WRITE-SUMMARY에서 DS-PLANT-CD(공장코드), DS-PROD-DATE(생산일자)를 MOVE하지 않고 WRITE함. 요약 파일의 키 필드가 초기값(공백/0)인 상태로 기록되어, 후속 프로그램에서 어떤 공장/일자의 집계인지 식별 불가.
- **DS-PROCESS-TIME, DS-STATUS-CD 미설정**: 요약 레코드의 처리시간과 상태코드도 설정하지 않음. DS-STATUS-CD의 88레벨 조건(정상/경고/에러)이 정의되어 있으나 활용되지 않음.
- **WS-FILE-STATUS 공유 불완전**: WS-FILE-STATUS는 PROD-TRANS-FILE에, WS-FILE-STATUS2는 DAILY-SUMMARY-FILE에 할당되어 있으나, 1000-INITIALIZE에서 두 파일 OPEN 후 WS-FILE-STATUS만 확인. DAILY-SUMMARY-FILE의 OPEN 실패(WS-FILE-STATUS2)는 감지하지 못함.
- **라인별 소계 미구분**: 변수명이 WS-LINE-TOTAL이지만 실제로는 라인별 구분 없이 전체 수량을 하나의 변수에 누적. 라인코드(PT-LINE-CD) 변경 시 소계 처리(control break) 로직이 없어, 모든 라인의 수량이 단일 합계로 집계됨.
- **WS-CURRENT-LINE 미사용**: WORKING-STORAGE에 선언된 WS-CURRENT-LINE(PIC X(10))이 프로그램 어디에서도 사용되지 않는 데드코드. 원래 라인별 소계용으로 설계되었을 가능성 있음.
- **CURRENT DATE 의존성**: DB2 UPDATE에서 WHERE 조건으로 `CURRENT DATE`를 사용하므로, 배치가 자정 이후에 실행되면 전일 데이터가 아닌 당일 행을 갱신하게 됨. JOB 스케줄링 시간에 민감.
- **UPDATE 대상 행 부재 시 미처리**: TB_DAILY_PROD에 당일 행이 없으면 SQLCODE = +100(NOT FOUND)이 발생하지만, SQLCODE ≠ 0 조건에 의해 에러로 처리됨. INSERT 또는 MERGE 로직이 없어, 사전에 당일 행이 존재해야만 정상 동작.
- **READ 시 파일 상태 미확인**: 1100 및 2000 단락에서 READ 후 AT END만 처리하고, I/O 에러(FILE STATUS ≠ '00' 및 '10') 상황을 확인하지 않음.