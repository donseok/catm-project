# PGM001 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM001 |
| 프로그램 목적 | 전일 생산라인별 실적 트랜잭션을 읽어 일일 생산수량을 집계하고, 요약 파일 및 DB2 테이블에 결과를 기록하는 일일 생산실적 집계 배치 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | PROD-TRANS-FILE (PRODTRAN) - 생산실적 트랜잭션 VSAM KSDS 파일 |
| 주요 출력 | DAILY-SUMMARY-FILE (DLYSMRY) - 일일 생산집계 요약 순차 파일, TB_DAILY_PROD DB2 테이블 |

## 2. 데이터 흐름

### 입력 데이터
- **PROD-TRANS-FILE (PRODTRAN)**: 생산실적 트랜잭션 파일 (VSAM KSDS, 순차 읽기)
  - 레코드 구조: CPYTRANS COPYBOOK 사용
  - 키: 공장코드(4) + 라인코드(10) + 생산일자(8) + 순번(5)

### 출력 데이터
- **DAILY-SUMMARY-FILE (DLYSMRY)**: 일일 생산집계 요약 파일 (순차 파일)
  - 레코드 구조: CPYSMRY COPYBOOK 사용
- **TB_DAILY_PROD**: DB2 일일 생산실적 테이블 (UPDATE)

### 사용 COPYBOOK
- **CPYTRANS**: 생산실적 트랜잭션 레코드 구조 (공장/라인/제품/수량/작업자/교대/상태 정보)
- **CPYSMRY**: 일일 생산집계 요약 레코드 구조 (공장/일자/총수량/건수/오류건수/상태)
- **DCLTBPROD**: TB_DAILY_PROD DB2 테이블의 DCLGEN (SQL INCLUDE)
- **SQLCA**: DB2 SQL 통신 영역

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 제어)
- **목적**: 전체 처리 흐름을 제어하는 메인 드라이버
- **처리 흐름**:
  1. 초기화 수행 (파일 오픈, 첫 레코드 읽기)
  2. EOF까지 트랜잭션 레코드를 반복 처리하며 집계
  3. 집계 결과를 요약 파일에 기록
  4. DB2 테이블에 집계 결과 반영
  5. 종료 처리 (파일 닫기, 완료 메시지 출력)

### 1000-INITIALIZE (초기화)
- **목적**: 입출력 파일을 열고 처리 준비
- **처리 흐름**:
  1. 생산실적 트랜잭션 파일(PROD-TRANS-FILE)을 입력 모드로 오픈
  2. 일일 집계 요약 파일(DAILY-SUMMARY-FILE)을 출력 모드로 오픈
  3. 파일 상태 코드 확인
  4. 첫 번째 레코드 읽기 수행
- **에러 처리**: 파일 오픈 실패 시(상태 코드 ≠ '00') 오류 메시지 출력 후 비정상 종료(9900-ABNORMAL-END) 호출

### 1100-READ-FIRST-RECORD (첫 레코드 읽기)
- **목적**: 트랜잭션 파일의 첫 번째 레코드를 읽어 처리 루프 진입 준비
- **처리 흐름**: 파일에서 첫 레코드 READ, 데이터가 없으면 EOF 플래그 설정

### 2000-PROCESS-RECORDS (레코드별 집계 처리)
- **목적**: 개별 생산실적 트랜잭션을 검증하고 집계에 반영
- **처리 흐름**:
  1. 생산수량(PT-QTY)을 기준으로 분기 처리
  2. 다음 레코드 읽기 (EOF이면 루프 종료)
- **조건 분기** (EVALUATE):
  - **PT-QTY > 0** (정상 생산): 생산수량을 라인 합계(WS-LINE-TOTAL)에 누적하고, 처리 건수(WS-DAILY-COUNT) 1 증가
  - **PT-QTY = 0** (수량 미기록): 오류 건수(WS-ERROR-COUNT) 1 증가 (수량 없는 트랜잭션을 오류로 분류)
  - **기타** (PT-QTY < 0, 음수 수량): 외부 오류 로깅 프로그램 호출 후 오류 건수 1 증가
- **호출 서브프로그램**: `ERRLOG` - 라인코드(PT-LINE-CD)와 수량(PT-QTY)을 전달하여 비정상 수량 이력 기록

### 3000-WRITE-SUMMARY (집계 결과 파일 출력)
- **목적**: 집계 완료된 일일 생산실적 요약 데이터를 출력 파일에 기록
- **처리 흐름**:
  1. 총 생산수량(WS-LINE-TOTAL) → DS-TOTAL-QTY로 이동
  2. 총 처리건수(WS-DAILY-COUNT) → DS-TOTAL-COUNT로 이동
  3. 오류건수(WS-ERROR-COUNT) → DS-ERROR-COUNT로 이동
  4. 요약 레코드 WRITE

### 4000-UPDATE-DB2 (DB2 테이블 갱신)
- **목적**: 당일자 일일 생산실적 집계 결과를 DB2 테이블에 반영
- **처리 흐름**:
  1. TB_DAILY_PROD 테이블의 당일(CURRENT DATE) 레코드를 UPDATE
  2. 총수량, 총건수, 오류건수 3개 컬럼 갱신
  3. SQL 실행 결과 확인
- **비즈니스 의미**: 배치 집계 결과를 DB2에 반영하여 온라인 조회나 타 시스템에서 당일 생산실적을 참조할 수 있게 함
- **에러 처리**: SQLCODE ≠ 0이면 SQL 오류 처리 프로그램(SQLERR) 호출
- **호출 서브프로그램**: `SQLERR` - SQLCODE를 전달하여 DB2 오류 로깅

### 9000-FINALIZE (종료 처리)
- **목적**: 리소스 정리 및 처리 결과 확인 메시지 출력
- **처리 흐름**:
  1. 입력 파일(PROD-TRANS-FILE) CLOSE
  2. 출력 파일(DAILY-SUMMARY-FILE) CLOSE
  3. 처리 건수 포함 완료 메시지 콘솔 출력

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오류 등 복구 불가 상황 발생 시 비정상 종료 처리
- **처리 흐름**:
  1. 파일 상태 코드 포함 오류 메시지 콘솔 출력
  2. ABEND 처리 프로그램 호출
  3. STOP RUN으로 프로그램 종료
- **호출 서브프로그램**: `ABNDPGM` - 파일 상태 코드를 전달하여 시스템 ABEND 처리

## 4. 비즈니스 규칙 요약

1. **정상 생산실적**: 생산수량(PT-QTY) > 0인 트랜잭션만 집계 수량에 반영
2. **수량 미기록 오류**: 생산수량이 정확히 0인 트랜잭션은 오류로 분류하되, 별도 로깅 없이 오류 건수만 증가
3. **음수 수량 오류**: 생산수량이 음수인 트랜잭션은 오류로 분류하고, ERRLOG 프로그램을 통해 라인코드와 수량을 상세 기록
4. **DB2 동기화**: 파일 기반 집계 결과와 동일한 데이터를 DB2 테이블에 이중으로 반영하여 온라인 참조 가능하게 함
5. **당일 기준 갱신**: DB2 UPDATE는 CURRENT DATE 기준으로 수행하므로, 반드시 익영업일에 전일자 데이터를 처리하는 운영 일정 준수 필요
6. **파일 오픈 실패 시 즉시 중단**: 입출력 파일 오픈 오류 발생 시 데이터 무결성 보호를 위해 즉시 비정상 종료

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **생산관리** (생산실적 집계), **품질관리** (불량/오류 건수 추적) |
| 모더나이제이션 시 주의사항 | ① 실시간 집계로 전환 시 배치 윈도우 의존성 제거 필요 ② DB2 UPDATE가 CURRENT DATE 기준이므로 실행 일자와 대상 일자 불일치 리스크 관리 필요 ③ ERRLOG/SQLERR/ABNDPGM 서브프로그램의 현대화 대체 방안 수립 필요 ④ COMP-3 (패킹 십진수) 데이터 타입의 정밀도 변환 검증 필요 |

## 6. 특이사항/리스크

- **WS-FILE-STATUS 공유 문제**: `WS-FILE-STATUS`는 PROD-TRANS-FILE에 할당되고, `WS-FILE-STATUS2`는 DAILY-SUMMARY-FILE에 할당되나, 초기화(1000-INITIALIZE)에서 `WS-FILE-STATUS`만 검사하고 `WS-FILE-STATUS2`는 검사하지 않음. 출력 파일 오픈 오류를 감지하지 못할 수 있음
- **요약 파일 키 미설정**: CPYSMRY에 DS-PLANT-CD, DS-PROD-DATE 키 필드가 존재하나, 3000-WRITE-SUMMARY에서 이 키 값을 설정하지 않고 WRITE함. 키 영역이 초기값(SPACE/ZERO)으로 기록될 수 있음
- **단일 레코드 출력**: 라인별/공장별 구분 없이 전체 트랜잭션을 단일 합계로 집계하여 요약 파일에 1건만 기록하는 구조. 프로그램 주석의 "라인별 실적 집계"와 실제 로직이 불일치
- **DB2 UPDATE 전제조건**: 당일자 레코드가 TB_DAILY_PROD에 사전 INSERT 되어 있어야 UPDATE가 성공함. INSERT가 없으면 SQLCODE=100 (NOT FOUND) 발생 가능
- **WRITE 오류 미검사**: 3000-WRITE-SUMMARY에서 WRITE 후 파일 상태 코드를 확인하지 않음
- **WS-CURRENT-LINE 미사용**: WORKING-STORAGE에 선언된 `WS-CURRENT-LINE PIC X(10)`이 프로그램 어디에서도 사용되지 않는 데드 변수
- **DS-PROCESS-TIME, DS-STATUS-CD 미설정**: CPYSMRY 레코드의 처리시간 및 상태코드 필드가 3000-WRITE-SUMMARY에서 설정되지 않음