# PGM001 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM001 |
| 프로그램 목적 | 전일 생산라인별 실적 트랜잭션을 읽어 일일 생산보고서를 집계·생성하고, 결과를 DB2 테이블에 반영하는 배치 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | PROD-TRANS-FILE (VSAM KSDS, DD=PRODTRAN) — 생산실적 트랜잭션 |
| 주요 출력 | DAILY-SUMMARY-FILE (순차파일, DD=DLYSMRY) — 일일 생산집계 요약 / DB2 TB_DAILY_PROD 테이블 갱신 |

## 2. 데이터 흐름

### 입력 데이터
- **PROD-TRANS-FILE** (VSAM KSDS): 생산라인별 개별 생산실적 트랜잭션. 키 = 공장코드(4) + 라인코드(10) + 생산일자(8) + 순번(5)

### 출력 데이터
- **DAILY-SUMMARY-FILE** (순차파일): 일일 집계 요약 레코드 (총수량, 총건수, 오류건수)
- **DB2 TB_DAILY_PROD**: 당일 기준 일일 생산실적 집계 결과 UPDATE

### 사용 COPYBOOK
| COPYBOOK | 역할 |
|----------|------|
| CPYTRANS | 생산실적 트랜잭션 레코드 구조 (입력 파일 레이아웃) |
| CPYSMRY | 일일 생산집계 요약 레코드 구조 (출력 파일 레이아웃) |
| DCLTBPROD | DB2 TB_DAILY_PROD 테이블의 DCLGEN (호스트 변수 선언) |
| SQLCA | DB2 SQL 통신 영역 |

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 제어)
- **목적**: 프로그램 전체 처리 흐름을 제어하는 메인 드라이버
- **처리 흐름**:
  1. 초기화 수행 (파일 오픈, 첫 레코드 읽기)
  2. 모든 트랜잭션 레코드를 순차적으로 처리 (EOF까지 반복)
  3. 집계 결과를 요약 파일에 기록
  4. DB2 테이블에 집계 결과 반영
  5. 종료 처리 (파일 닫기, 완료 메시지)

### 1000-INITIALIZE (초기화)
- **목적**: 입출력 파일을 열고, 정상 오픈 여부를 확인한 후 첫 레코드를 읽음
- **처리 흐름**:
  1. PROD-TRANS-FILE을 INPUT으로 오픈
  2. DAILY-SUMMARY-FILE을 OUTPUT으로 오픈
  3. 파일 상태 코드가 '00'이 아니면 비정상 종료 처리
  4. 첫 번째 트랜잭션 레코드를 읽음
- **에러 처리**: 파일 오픈 실패 시 9900-ABNORMAL-END로 분기하여 비정상 종료

### 1100-READ-FIRST-RECORD (최초 레코드 읽기)
- **목적**: 루프 진입 전 첫 번째 레코드를 선행 읽기(priming read)
- **처리 흐름**: PROD-TRANS-FILE에서 1건 READ, 파일이 비어있으면 EOF 플래그 설정

### 2000-PROCESS-RECORDS (실적 레코드 처리)
- **목적**: 각 생산실적 트랜잭션을 검증하고 유효 건은 집계, 오류 건은 분류 처리
- **처리 흐름**:
  1. 생산수량(PT-QTY) 값에 따른 분기 처리
  2. 다음 레코드 읽기 (EOF 도달 시 루프 종료)
- **조건 분기** (EVALUATE):
  - **PT-QTY > 0** (정상 생산실적): 수량을 라인 합계에 누적, 처리 건수 +1
  - **PT-QTY = 0** (수량 미입력): 오류 건수 +1 (데이터 누락으로 간주)
  - **PT-QTY < 0** (음수, 비정상 값): 오류 로깅 프로그램 호출 후 오류 건수 +1
- **호출 서브프로그램**: `ERRLOG` — 비정상 수량(음수) 발생 시 라인코드(PT-LINE-CD)와 수량(PT-QTY)을 전달하여 오류 이력 기록

### 3000-WRITE-SUMMARY (집계 요약 기록)
- **목적**: 누적된 집계 결과를 일일 요약 파일에 출력
- **처리 흐름**:
  1. 총생산수량(WS-LINE-TOTAL) → DS-TOTAL-QTY로 이동
  2. 총처리건수(WS-DAILY-COUNT) → DS-TOTAL-COUNT로 이동
  3. 오류건수(WS-ERROR-COUNT) → DS-ERROR-COUNT로 이동
  4. 요약 레코드 1건 WRITE

### 4000-UPDATE-DB2 (DB2 테이블 갱신)
- **목적**: 당일 기준 일일 생산실적 집계를 DB2 테이블에 반영
- **처리 흐름**:
  1. TB_DAILY_PROD 테이블에서 PROD_DATE = 당일(CURRENT DATE)인 행의 총수량, 총건수, 오류건수를 UPDATE
  2. SQL 실행 결과 확인
- **비즈니스 의미**: 배치 집계 결과를 온라인에서 조회할 수 있도록 DB2에 동기화. 이를 통해 일일 생산현황 조회 화면 등에서 실시간 반영된 집계 데이터를 사용 가능
- **에러 처리**: SQLCODE ≠ 0이면 `SQLERR` 프로그램을 호출하여 SQL 오류 처리 (단, 프로그램 중단 없이 계속 진행됨)
- **호출 서브프로그램**: `SQLERR` — SQLCODE를 전달하여 DB2 오류 로깅

### 9000-FINALIZE (종료 처리)
- **목적**: 파일을 닫고 처리 완료 메시지를 출력
- **처리 흐름**:
  1. 입력 파일(PROD-TRANS-FILE) CLOSE
  2. 출력 파일(DAILY-SUMMARY-FILE) CLOSE
  3. 콘솔에 처리 건수 포함 완료 메시지 출력

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오픈 실패 등 치명적 오류 발생 시 비정상 종료 처리
- **처리 흐름**:
  1. 파일 상태 코드 포함 오류 메시지 출력
  2. `ABNDPGM` 프로그램 호출 (비정상 종료 로깅/처리)
  3. STOP RUN으로 프로그램 강제 종료
- **호출 서브프로그램**: `ABNDPGM` — 비정상 종료 시 파일 상태 코드를 전달하여 운영 이벤트 기록

## 4. 비즈니스 규칙 요약

1. **생산수량 양수(> 0)**: 정상 실적으로 인정하여 일일 집계에 누적
2. **생산수량 영(= 0)**: 데이터 누락 또는 미입력으로 간주하여 오류 건수만 증가 (별도 로깅 없음)
3. **생산수량 음수(< 0)**: 비정상 데이터로 판단하여 ERRLOG에 오류 이력을 남기고 오류 건수 증가
4. **일일 집계 단위**: 모든 생산라인의 실적을 단일 합산으로 집계 (라인별 분리 집계 아님)
5. **DB2 반영 기준**: CURRENT DATE(당일) 조건으로 UPDATE하므로, 반드시 당일 실행되어야 정확한 결과 보장
6. **파일 오픈 실패 시**: 프로그램 즉시 비정상 종료(ABEND) 처리

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **생산관리** (생산실적 집계, 일일 생산보고서), **품질관리** (불량/오류 건수 추적) |
| 모더나이제이션 시 주의사항 | ① 현재 라인별 소계 없이 전체 합산만 수행 → MES에서는 라인별/교대별/제품별 다차원 집계가 필요할 수 있음 ② DB2 UPDATE가 CURRENT DATE 기준이므로 재처리(re-run) 시 날짜 조건 충돌 가능 → 멱등성 확보 필요 ③ ERRLOG, SQLERR, ABNDPGM 등 외부 서브프로그램 의존성 파악 필요 |

## 6. 특이사항/리스크

- **라인별 소계 미구현**: `WS-CURRENT-LINE` 변수가 WORKING-STORAGE에 선언되어 있으나 어디에서도 사용되지 않음. 라인별 집계를 구현하려다 미완성으로 남은 것으로 추정 → **데드코드**
- **요약 레코드 키 미설정**: CPYSMRY의 DS-PLANT-CD, DS-PROD-DATE 키 필드에 값을 MOVE하지 않고 WRITE함. 출력 파일의 키 영역이 초기값(SPACES/ZEROS)으로 기록될 가능성
- **요약 레코드 부가 필드 미설정**: DS-PROCESS-TIME, DS-STATUS-CD 필드에도 값을 설정하지 않음 → 수신 프로그램에서 잘못된 상태 판단 가능
- **DB2 UPDATE 실패 시 계속 진행**: SQLCODE ≠ 0일 때 SQLERR을 호출하지만 프로그램을 중단하지 않음. DB2 반영 실패 상태로 파일만 생성되어 데이터 불일치 발생 가능
- **DB2 UPDATE 대상 없음 미처리**: 당일 데이터가 TB_DAILY_PROD에 미존재 시 UPDATE 대상이 0건(SQLCODE=100)이 되어도 INSERT를 수행하지 않음 → 최초 실행 시 데이터 누락
- **CLOSE 시 파일 상태 미확인**: 9000-FINALIZE에서 파일 CLOSE 후 WS-FILE-STATUS를 검사하지 않음
- **단일 합산 한계**: 공장코드(PT-PLANT-CD), 라인코드(PT-LINE-CD), 교대코드(PT-SHIFT-CD), 제품코드(PT-PRODUCT-CD) 등 다차원 분석 키를 활용하지 않고 단순 총합산만 수행