# PGM001 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM001 |
| 프로그램 목적 | 전일 생산라인별 실적을 집계하여 일일 생산보고서를 생성하고, DB2 테이블에 집계 결과를 반영한다 |
| 처리 유형 | 배치 |
| 주요 입력 | 생산실적 트랜잭션 파일 (PRODTRAN, VSAM KSDS) |
| 주요 출력 | 일일집계 요약 파일 (DLYSMRY, 순차파일), DB2 테이블 (TB_DAILY_PROD) |

## 2. 데이터 흐름

### 입력 데이터
- **PROD-TRANS-FILE (DD: PRODTRAN)** — VSAM 색인순차(KSDS) 파일. 생산라인별 트랜잭션 레코드. 키 구조: 공장코드(4) + 라인코드(10) + 생산일자(8) + 일련번호(5)

### 출력 데이터
- **DAILY-SUMMARY-FILE (DD: DLYSMRY)** — 순차파일. 일일 생산 집계 결과 (총수량, 총건수, 오류건수)
- **TB_DAILY_PROD** — DB2 테이블. 당일 생산집계 결과를 UPDATE

### 사용 COPYBOOK
- **CPYTRANS** — 생산실적 트랜잭션 레코드 구조 (공장/라인/제품/수량/교대/상태 등)
- **CPYSMRY** — 일일집계 요약 레코드 구조 (소스 미제공, DS-TOTAL-QTY, DS-TOTAL-COUNT, DS-ERROR-COUNT 필드 사용)
- **DCLTBPROD** — DB2 테이블 TB_DAILY_PROD의 DCLGEN 구조체

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 제어)
- **목적**: 프로그램 전체 흐름을 제어하는 최상위 단락
- **처리 흐름**:
  1. 초기화 (파일 오픈, 첫 레코드 읽기)
  2. 트랜잭션 레코드를 EOF까지 반복 처리
  3. 집계 결과를 요약 파일에 기록
  4. DB2 테이블에 집계 결과 반영
  5. 종료 처리 (파일 닫기, 완료 메시지)

### 1000-INITIALIZE (초기화)
- **목적**: 입출력 파일을 열고 정상 오픈 여부를 확인
- **처리 흐름**:
  1. 생산실적 트랜잭션 파일을 INPUT으로 오픈
  2. 일일집계 요약 파일을 OUTPUT으로 오픈
  3. 파일 상태 코드 확인 후 첫 레코드 읽기
- **에러 처리**: 파일 오픈 실패 시 (FILE STATUS ≠ '00') 상태코드를 표시하고 비정상 종료(9900-ABNORMAL-END) 수행

### 1100-READ-FIRST-RECORD (첫 레코드 읽기)
- **목적**: 트랜잭션 파일의 첫 레코드를 읽어 처리 루프 진입 준비
- **처리 흐름**: 레코드 읽기 시도. 파일이 비어있으면 EOF 플래그 설정

### 2000-PROCESS-RECORDS (레코드별 실적 집계)
- **목적**: 개별 생산 트랜잭션을 검증하고 집계에 반영
- **처리 흐름**:
  1. 생산수량(PT-QTY) 값에 따라 분기 처리
  2. 다음 레코드 읽기
- **조건 분기**:
  - **PT-QTY > 0 (정상 생산)**: 수량을 라인 합계(WS-LINE-TOTAL)에 누적, 처리 건수(WS-DAILY-COUNT) 1 증가
  - **PT-QTY = 0 (수량 없음)**: 오류 건수(WS-ERROR-COUNT) 1 증가. 수량이 0인 트랜잭션은 비정상으로 간주
  - **기타 (음수 등)**: 외부 오류 로깅 프로그램 호출 후 오류 건수 증가
- **호출 서브프로그램**: `ERRLOG` — 라인코드(PT-LINE-CD)와 수량(PT-QTY)을 전달하여 이상 데이터를 기록

### 3000-WRITE-SUMMARY (집계 결과 파일 출력)
- **목적**: 누적된 일일 집계 결과를 요약 파일에 기록
- **처리 흐름**:
  1. 총 생산수량 → DS-TOTAL-QTY
  2. 총 처리건수 → DS-TOTAL-COUNT
  3. 오류 건수 → DS-ERROR-COUNT
  4. 요약 레코드 WRITE

### 4000-UPDATE-DB2 (DB2 테이블 갱신)
- **목적**: 일일 생산집계 결과를 DB2 테이블에 반영
- **처리 흐름**:
  1. TB_DAILY_PROD 테이블의 당일(CURRENT DATE) 레코드를 UPDATE
  2. TOTAL_QTY, TOTAL_COUNT, ERROR_COUNT 컬럼에 집계값 반영
- **에러 처리**: SQLCODE ≠ 0이면 `SQLERR` 서브프로그램 호출하여 SQL 오류 처리
- **호출 서브프로그램**: `SQLERR` — SQLCODE를 전달하여 DB2 오류를 기록/처리

### 9000-FINALIZE (정상 종료)
- **목적**: 파일 닫기 및 완료 메시지 출력
- **처리 흐름**:
  1. 입출력 파일 모두 CLOSE
  2. 처리 건수와 함께 정상 완료 메시지 DISPLAY

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오픈 실패 등 치명적 오류 시 비정상 종료 처리
- **처리 흐름**:
  1. 파일 상태 코드 포함 오류 메시지 DISPLAY
  2. `ABNDPGM` 서브프로그램 호출 (비정상 종료 공통 모듈)
  3. STOP RUN으로 즉시 종료
- **호출 서브프로그램**: `ABNDPGM` — 파일 상태 코드를 전달하여 ABEND 처리

## 4. 비즈니스 규칙 요약

1. **정상 생산**: 생산수량(PT-QTY) > 0인 트랜잭션만 생산 실적으로 집계한다
2. **수량 누락**: 생산수량이 정확히 0인 경우 오류 건수로 분류한다 (데이터 입력 오류로 간주)
3. **음수 수량**: 생산수량이 음수인 경우 오류 로그(ERRLOG)에 기록하고 오류 건수로 분류한다
4. **일일 집계 단위**: 전체 생산라인의 실적을 하나의 합산값으로 집계한다 (라인별 소계 없음)
5. **이중 기록**: 집계 결과는 순차파일과 DB2 테이블 양쪽에 모두 기록한다
6. **DB2 갱신 조건**: TB_DAILY_PROD 테이블에서 당일(CURRENT DATE) 레코드를 UPDATE한다 (INSERT가 아닌 UPDATE이므로, 해당 일자 레코드가 사전에 존재해야 함)

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | 생산관리 (일일 생산실적 집계), 품질관리 (불량/오류 건수 추적) |
| 모더나이제이션 시 주의사항 | ① DB2 UPDATE는 당일 레코드가 미리 INSERT되어 있어야 동작하므로, 선행 배치 또는 스케줄링 의존성 확인 필요 ② ERRLOG, SQLERR, ABNDPGM 등 외부 서브프로그램 3개의 현대화 또는 대체 방안 병행 필요 ③ 파일 기반 출력(DLYSMRY)과 DB2 출력이 이중화되어 있어 현대화 시 단일 채널로 통합 검토 가능 |

## 6. 특이사항/리스크

- **라인별 소계 미생성**: WS-CURRENT-LINE 변수가 선언되어 있으나(line 43) 어디에서도 사용되지 않음. 원래 라인별 소계 기능이 계획되었으나 미구현된 것으로 추정 → **데드코드**
- **FILE STATUS 변수 공유 위험**: WS-FILE-STATUS는 PROD-TRANS-FILE에, WS-FILE-STATUS2는 DAILY-SUMMARY-FILE에 매핑되어 있으나, 1000-INITIALIZE에서 WS-FILE-STATUS만 체크하고 WS-FILE-STATUS2(출력 파일)의 오픈 상태는 확인하지 않음
- **WRITE 오류 미처리**: 3000-WRITE-SUMMARY에서 DAILY-SUMMARY-REC를 WRITE할 때 FILE STATUS를 확인하지 않음
- **DB2 UPDATE 실패 시 계속 진행**: 4000-UPDATE-DB2에서 SQLCODE ≠ 0이면 SQLERR을 호출하지만, 이후 정상 종료(9000-FINALIZE)로 진행됨. DB2 갱신 실패가 프로그램 종료 코드에 반영되지 않을 수 있음
- **CURRENT DATE 의존**: DB2 UPDATE의 WHERE 조건이 CURRENT DATE를 사용하므로, 배치 실행 시점이 자정을 넘기면 잘못된 날짜에 UPDATE될 위험
- **단일 요약 레코드**: 전체 입력을 하나의 요약 레코드로만 출력하므로, 공장별/라인별/교대별 세분화된 분석이 불가