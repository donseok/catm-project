# PGM001 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM001 |
| 프로그램 목적 | 전일 생산라인별 실적을 집계하여 일일 생산보고서를 생성하고, DB2 테이블에 집계 결과를 반영하는 일일 배치 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | PROD-TRANS-FILE (VSAM KSDS - 생산실적 트랜잭션 파일) |
| 주요 출력 | DAILY-SUMMARY-FILE (순차 파일 - 일일 생산 집계), TB_DAILY_PROD (DB2 테이블) |

## 2. 데이터 흐름

### 입력 데이터
- **PROD-TRANS-FILE** (DD명: PRODTRAN) — VSAM 색인순차(KSDS) 파일, 순차 접근. 키: 공장코드(4) + 라인코드(10) + 생산일자(8) + 일련번호(5)
- **DCLTBPROD** — DB2 DCLGEN (TB_DAILY_PROD 테이블 레이아웃, SQL UPDATE에 사용)

### 출력 데이터
- **DAILY-SUMMARY-FILE** (DD명: DLYSMRY) — 순차 파일, 일일 집계 결과 (총수량, 총건수, 오류건수)
- **TB_DAILY_PROD** — DB2 테이블, 당일 날짜 기준으로 집계 결과 UPDATE

### 사용 COPYBOOK
- **CPYTRANS** — 생산실적 트랜잭션 레코드 구조 (공장/라인/제품/수량/작업자/교대 등)
- **CPYSMRY** — 일일 집계 요약 레코드 구조 (소스 미제공, DS-TOTAL-QTY / DS-TOTAL-COUNT / DS-ERROR-COUNT 필드 사용)

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 제어)
- **목적**: 프로그램 전체 흐름을 제어하는 최상위 단락
- **처리 흐름**:
  1. 초기화 수행 (1000-INITIALIZE)
  2. EOF까지 레코드 단위 처리 반복 (2000-PROCESS-RECORDS)
  3. 집계 결과를 파일에 기록 (3000-WRITE-SUMMARY)
  4. DB2 테이블에 집계 결과 반영 (4000-UPDATE-DB2)
  5. 종료 처리 (9000-FINALIZE)

### 1000-INITIALIZE (초기화)
- **목적**: 입출력 파일 오픈 및 첫 번째 레코드 읽기
- **처리 흐름**:
  1. 생산실적 트랜잭션 파일을 INPUT으로 OPEN
  2. 일일 집계 파일을 OUTPUT으로 OPEN
  3. 파일 상태 코드가 '00'이 아니면 비정상 종료 처리
  4. 첫 번째 레코드를 미리 읽기 (priming read)
- **에러 처리**: 파일 오픈 실패 시 9900-ABNORMAL-END 호출

### 1100-READ-FIRST-RECORD (최초 레코드 읽기)
- **목적**: 루프 진입 전 첫 번째 트랜잭션 레코드를 읽는 프라이밍 리드
- **처리 흐름**: 파일 끝이면 WS-EOF를 'Y'로 설정하여 처리 루프를 건너뜀

### 2000-PROCESS-RECORDS (레코드 처리 — 핵심 비즈니스 로직)
- **목적**: 각 생산실적 트랜잭션 레코드의 수량을 검증하고 집계
- **처리 흐름**:
  1. 생산수량(PT-QTY) 값을 평가
  2. 다음 레코드를 읽기 (읽기 루프 패턴)
- **조건 분기** (EVALUATE):
  - **PT-QTY > 0** (정상 생산): 수량을 라인 합계(WS-LINE-TOTAL)에 누적, 일일 처리건수(WS-DAILY-COUNT) 1 증가
  - **PT-QTY = 0** (수량 미입력): 오류건수(WS-ERROR-COUNT) 1 증가 (별도 오류 로깅 없음)
  - **PT-QTY < 0** (음수 — 비정상): ERRLOG 서브프로그램 호출 후 오류건수 1 증가
- **호출 서브프로그램**: `ERRLOG` — 라인코드(PT-LINE-CD)와 수량(PT-QTY)을 파라미터로 전달하여 이상 데이터 로깅

### 3000-WRITE-SUMMARY (집계 파일 출력)
- **목적**: 누적된 집계 결과를 일일 요약 파일에 기록
- **처리 흐름**:
  1. WS-LINE-TOTAL → DS-TOTAL-QTY (총 생산수량)
  2. WS-DAILY-COUNT → DS-TOTAL-COUNT (총 처리건수)
  3. WS-ERROR-COUNT → DS-ERROR-COUNT (오류건수)
  4. DAILY-SUMMARY-REC WRITE

### 4000-UPDATE-DB2 (DB2 테이블 갱신)
- **목적**: 집계 결과를 DB2 일일생산 테이블에 반영
- **처리 흐름**:
  1. TB_DAILY_PROD 테이블에서 PROD_DATE = CURRENT DATE인 행을 UPDATE
  2. TOTAL_QTY, TOTAL_COUNT, ERROR_COUNT 컬럼에 집계값 설정
- **에러 처리**: SQLCODE ≠ 0이면 `SQLERR` 서브프로그램 호출
- **호출 서브프로그램**: `SQLERR` — SQLCODE를 파라미터로 전달하여 SQL 에러 로깅

### 9000-FINALIZE (정상 종료)
- **목적**: 파일 닫기 및 완료 메시지 출력
- **처리 흐름**:
  1. 입출력 파일 모두 CLOSE
  2. 처리 건수 DISPLAY 출력 (운영 로그 용도)

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오픈 실패 등 치명적 오류 시 비정상 종료 처리
- **처리 흐름**:
  1. 파일 상태 코드를 DISPLAY로 출력
  2. `ABNDPGM` 서브프로그램 호출 (비정상 종료 공통 모듈)
  3. STOP RUN
- **호출 서브프로그램**: `ABNDPGM` — 파일 상태 코드를 파라미터로 전달

## 4. 비즈니스 규칙 요약

1. **생산수량 양수** (PT-QTY > 0): 정상 실적으로 인정하여 일일 합계에 누적
2. **생산수량 0**: 오류로 분류하되, 별도 에러 로그 없이 오류건수만 증가 (데이터 미입력 취급)
3. **생산수량 음수**: 이상 데이터로 판단하여 ERRLOG로 에러 로그 기록 후 오류건수 증가
4. **DB2 반영 기준**: CURRENT DATE (시스템 당일 날짜) 기준으로 기존 행을 UPDATE (INSERT 아님)
5. **파일 오픈 실패 시**: 즉시 비정상 종료 (ABNDPGM 호출)
6. **집계 범위**: 전체 생산라인을 하나의 합계로 집계 (라인별 개별 집계 없음)

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **생산관리** (일일 생산실적 집계), **품질관리** (불량/이상 데이터 분류) |
| 모더나이제이션 시 주의사항 | 1) CURRENT DATE 기준 UPDATE이므로 배치 실행 시점(자정 이후 등)에 따른 날짜 불일치 위험 검토 필요. 2) 라인별 개별 집계가 아닌 전체 합산이므로 MES 전환 시 라인별/교대별 세분화 집계 설계 필요. 3) ERRLOG/SQLERR/ABNDPGM 서브프로그램의 현대화 대체 방안 수립 필요. 4) VSAM→RDB 전환 시 키 구조(공장+라인+일자+순번) 보존 필요. |

## 6. 특이사항/리스크

- **라인별 집계 미지원**: WS-CURRENT-LINE 변수가 선언되어 있으나(라인 43행) 어디에서도 사용되지 않음. 원래 라인별 집계를 의도했으나 미구현된 것으로 추정 → **데드코드**
- **파일 상태 코드 공유 위험**: WS-FILE-STATUS는 PROD-TRANS-FILE에만 연결되고 WS-FILE-STATUS2는 DAILY-SUMMARY-FILE에 연결되나, 1000-INITIALIZE에서 WS-FILE-STATUS만 검사. DAILY-SUMMARY-FILE의 오픈 실패를 감지하지 못함
- **DB2 UPDATE 실패 시 프로그램 계속 진행**: SQLERR 호출 후 정상 흐름으로 복귀하여 9000-FINALIZE를 수행함. UPDATE 실패에도 정상 종료되므로 데이터 불일치 가능
- **CURRENT DATE 의존**: 배치 실행 시점이 자정을 넘기면 전일 데이터를 당일 날짜로 UPDATE하는 논리적 오류 발생 가능. 파라미터로 기준일자를 받는 것이 안전
- **단일 레코드 출력**: 3000-WRITE-SUMMARY는 루프 외부에서 1회만 실행되므로 전체 합산 1건만 출력. 라인별/교대별 분석이 불가능한 구조
- **READ 시 파일 상태 미검사**: 2000-PROCESS-RECORDS와 1100-READ-FIRST-RECORD에서 READ 후 AT END만 처리하고, 파일 상태 코드(예: I/O 에러 '30' 등)를 검사하지 않아 디스크 오류 등의 비정상 상황 감지 불가