# PGM003 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM003 |
| 프로그램 목적 | 생산라인에서 발생하는 품질검사 결과를 실시간으로 수신하여 합격/불량/재작업 판정을 수행하고, 품질이력을 기록하며, 불량률 기반 경고/위험 알림을 발생시키는 품질검사 처리 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | QC-RESULT-FILE (QCRSLT) - 품질검사 결과 VSAM KSDS 파일 |
| 주요 출력 | QC-HISTORY-FILE (QCHIST) - 품질검사 이력 순차파일, TB_QC_DAILY_SUMMARY DB2 테이블 |

## 2. 데이터 흐름

### 입력 데이터
- **QC-RESULT-FILE (QCRSLT)**: 인덱스 순차파일(VSAM KSDS), 동적 접근 모드. 키는 공장코드+라인코드+검사일자+검사ID 복합키. COPYBOOK `CPYQCRS` 레이아웃 사용.

### 출력 데이터
- **QC-HISTORY-FILE (QCHIST)**: 순차파일. 검사 결과 이력을 시간순으로 기록. COPYBOOK `CPYQCHS` 레이아웃 사용.
- **TB_QC_DAILY_SUMMARY**: DB2 테이블. 일별 라인별 품질검사 요약 통계(총검사수, 합격수, 불량수, 불량률) INSERT.

### 사용 COPYBOOK
| COPYBOOK | 역할 |
|----------|------|
| CPYQCRS | 품질검사 결과 레코드 레이아웃 (입력) - 검사키, 제품코드, 판정코드, 불량유형, 측정값, 상/하한값, 재작업 횟수 등 |
| CPYQCHS | 품질검사 이력 레코드 레이아웃 (출력) - 검사ID, 라인, 제품, 판정, 최종결과 |
| SQLCA | DB2 SQL 통신 영역 |
| DCLTBQC | DB2 테이블 DCLGEN (TB_QC 관련 호스트 변수) |

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 제어)
- **목적**: 전체 처리 흐름을 제어하는 메인 루틴
- **처리 흐름**:
  1. 초기화 (파일 오픈)
  2. 검사 결과 레코드를 EOF까지 반복 처리
  3. 불량률 계산
  4. 일일 품질요약 DB2 테이블 갱신
  5. 불량률 기준 경고/위험 알림 확인
  6. 종료 처리 (파일 클로즈)

### 1000-INITIALIZE (초기화)
- **목적**: 입출력 파일 오픈 및 정상 여부 확인
- **처리 흐름**:
  1. QC-RESULT-FILE을 INPUT으로 오픈
  2. QC-HISTORY-FILE을 OUTPUT으로 오픈
  3. 각 파일의 FILE STATUS 확인
  4. 첫 번째 레코드 읽기 수행
- **에러 처리**: FILE STATUS가 '00'이 아니면 에러 메시지 출력 후 `9900-ABNORMAL-END`로 비정상 종료

### 1100-READ-FIRST-RECORD (첫 레코드 읽기)
- **목적**: 검사 결과 파일의 첫 번째 레코드를 읽어 루프 진입 준비
- **처리 흐름**: 파일 끝이면 EOF 플래그 설정

### 2000-PROCESS-INSPECTION (검사 결과 처리 - 핵심 루프)
- **목적**: 개별 검사 결과를 판정 코드에 따라 분기 처리
- **처리 흐름**:
  1. 검사 건수 1 증가
  2. 판정 코드(`QR-JUDGE-CD`)에 따라 분기 처리
  3. 이력 파일에 기록
  4. 다음 레코드 읽기
- **조건 분기** (`EVALUATE QR-JUDGE-CD`):

| 판정코드 | 의미 | 처리 |
|----------|------|------|
| `'P'` (Pass) | 합격 | 합격 건수 증가, 합격 기록 |
| `'F'` (Fail) | 불량 | 불량 건수 증가, 불량 기록 (치명불량 시 즉시 알림) |
| `'R'` (Rework) | 재작업 | 재작업 기록 (재작업 3회 초과 시 불량 전환) |
| 기타 | 미정의 코드 | 에러 로그 기록 (`ERRLOG` 호출) |

### 2100-RECORD-PASS (합격 처리)
- **목적**: 합격 판정 결과를 기록
- **처리 흐름**: 이전 결과값을 'OK'로 설정

### 2200-RECORD-DEFECT (불량 처리)
- **목적**: 불량 판정 결과를 기록하고, 치명 불량 시 즉시 알림 발생
- **처리 흐름**:
  1. 이전 결과값을 'NG'로 설정
  2. 불량 유형이 'A'(치명 불량)이면 `QCALERT` 프로그램 호출하여 즉시 알림
- **조건 분기**: `QR-DEFECT-TYPE = 'A'` → 치명 결함 즉시 알림
- **호출 서브프로그램**: `QCALERT` - 라인코드, 제품코드, 불량유형을 전달하여 품질 알림 발생

### 2300-RECORD-REWORK (재작업 처리)
- **목적**: 재작업 판정을 처리하되, 재작업 횟수가 한도를 초과하면 불량으로 전환
- **처리 흐름**:
  1. 이전 결과값을 'RW'로 설정
  2. 재작업 횟수(`QR-REWORK-CNT`)가 3회 초과 시:
     - 판정 코드를 'F'(불량)로 변경
     - 불량 건수 1 증가
     - 에러 로그 기록
- **비즈니스 규칙**: 동일 품목이 3회를 초과하여 재작업되면 더 이상 재작업이 불가하며 최종 불량으로 처리
- **호출 서브프로그램**: `ERRLOG` - 검사ID와 재작업 횟수를 전달하여 로그 기록

### 2400-WRITE-HISTORY (이력 기록)
- **목적**: 처리 완료된 검사 결과를 이력 파일에 기록
- **처리 흐름**: 입력 레코드(CPYQCRS)의 주요 필드를 이력 레코드(CPYQCHS)로 매핑하여 기록
  - `QR-INSPECT-ID` → `QH-INSPECT-ID`
  - `QR-LINE-CD` → `QH-LINE-CD`
  - `QR-PRODUCT-CD` → `QH-PRODUCT-CD`
  - `QR-JUDGE-CD` → `QH-JUDGE-CD` (재작업→불량 전환이 반영된 최종 판정)
  - `QR-INSPECT-DT` → `QH-INSPECT-DT`
  - `WS-PREV-RESULT` → `QH-FINAL-RESULT` (OK/NG/RW)

### 3000-CALCULATE-RATE (불량률 계산)
- **목적**: 전체 검사 건수 대비 불량률(%)을 산출
- **처리 흐름**:
  - 검사 건수 > 0이면: `불량률 = (불량건수 / 검사건수) × 100`
  - 검사 건수 = 0이면: 불량률을 0으로 설정 (0 나누기 방지)

### 4000-UPDATE-QC-SUMMARY (일일 품질요약 DB2 갱신)
- **목적**: 당일 라인별 품질검사 집계 결과를 DB2 일일요약 테이블에 저장
- **처리 흐름**: `TB_QC_DAILY_SUMMARY` 테이블에 INSERT
  - 검사일자: `CURRENT DATE` (시스템 당일)
  - 라인코드, 총검사수, 합격수, 불량수, 불량률
- **에러 처리**: `SQLCODE ≠ 0`이면 `SQLERR` 프로그램 호출
- **호출 서브프로그램**: `SQLERR` - SQLCODE를 전달하여 SQL 에러 처리
- **주의**: INSERT만 수행하므로 동일 일자/라인에 대해 재실행 시 중복 행이 발생할 수 있음 (MERGE/UPSERT 미사용)

### 5000-CHECK-ALERT (불량률 경고 확인)
- **목적**: 불량률이 기준치를 초과하면 경고 또는 위험 알림 발생
- **조건 분기**:

| 조건 | 수준 | 동작 |
|------|------|------|
| 불량률 > 5.00% | **CRITICAL** (위험) | 콘솔 출력 + `QCALERT` 호출 (라인코드, 제품코드, 불량률 전달) |
| 불량률 > 2.50% | **WARNING** (경고) | 콘솔 출력만 |
| 불량률 ≤ 2.50% | 정상 | 아무 동작 없음 |

- **호출 서브프로그램**: `QCALERT` - 위험 수준일 때만 호출

### 9000-FINALIZE (종료 처리)
- **목적**: 파일 클로즈 및 처리 결과 요약 출력
- **처리 흐름**:
  1. 입출력 파일 모두 닫기
  2. 총 검사 건수와 불량 건수를 콘솔에 출력

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오픈 실패 시 비정상 종료 처리
- **처리 흐름**: 에러 메시지 출력 → `ABNDPGM` 호출 → STOP RUN
- **호출 서브프로그램**: `ABNDPGM` - 파일 상태 코드를 전달하여 비정상 종료 처리

## 4. 비즈니스 규칙 요약

1. **판정 3분류**: 품질검사 결과는 합격(P), 불량(F), 재작업(R) 세 가지로 분류된다.
2. **재작업 한도**: 재작업 횟수가 3회를 초과하면 자동으로 불량(F)으로 전환된다.
3. **치명 불량 즉시 알림**: 불량 유형이 'A'(치명)인 경우, 불량 발견 즉시 `QCALERT`를 통해 알림을 발생시킨다.
4. **불량률 위험 기준**: 전체 불량률이 5.00%를 초과하면 CRITICAL 알림을 발생시킨다.
5. **불량률 경고 기준**: 전체 불량률이 2.50%를 초과하면 WARNING 메시지를 출력한다.
6. **일일 품질요약 집계**: 검사 완료 후 당일 라인별 검사통계(총검사수, 합격수, 불량수, 불량률)를 DB2에 저장한다.
7. **전수 이력 기록**: 판정 결과에 관계없이 모든 검사 건은 이력 파일에 기록된다.
8. **미정의 판정코드 로깅**: P/F/R 이외의 판정코드는 에러 로그로 기록한다.

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **품질관리(QC/QM)** - 인라인 품질검사 결과 처리, 불량 판정, 불량률 모니터링, 품질 알림, SPC 데이터 수집의 기초가 되는 핵심 품질관리 프로그램 |
| 모더나이제이션 시 주의사항 | ① 실시간 알림(`QCALERT`) 연동 인터페이스를 REST API/메시지큐로 전환 필요 ② DB2 INSERT의 중복 방지 로직(UPSERT) 추가 필요 ③ 재작업 3회 한도 등 비즈니스 규칙을 설정값으로 외부화 권장 ④ VSAM KSDS → RDBMS 전환 시 키 구조(공장+라인+일자+검사ID) 보존 필요 |

## 6. 특이사항/리스크

- **매직넘버 (하드코딩)**:
  - 재작업 한도 `3`회 (소스 라인 011700) — 설정 파일이나 테이블로 외부화 권장
  - 불량률 위험 기준 `5.00%`, 경고 기준 `2.50%`는 WORKING-STORAGE에 초기값으로 설정되어 있으나 외부 설정 연동 없음

- **DB2 INSERT 중복 위험**: `4000-UPDATE-QC-SUMMARY`에서 INSERT만 수행하므로, 동일 일자/라인에 대해 프로그램을 재실행하면 중복 행이 발생함. MERGE 또는 키 충돌 처리가 없음.

- **FILE STATUS 미검사 구간**: `2400-WRITE-HISTORY`에서 WRITE 후 FILE STATUS를 확인하지 않음. 이력 파일 쓰기 실패 시 무시될 수 있음.

- **마지막 레코드의 라인코드 의존**: `4000-UPDATE-QC-SUMMARY`와 `5000-CHECK-ALERT`에서 `QR-LINE-CD`를 사용하는데, 이는 마지막으로 읽은 레코드의 라인코드임. 다중 라인의 검사 결과가 섞여 있을 경우 라인코드가 정확하지 않을 수 있음.

- **합격 건수 미포함**: 재작업(R) 판정은 합격(`WS-PASS-COUNT`)에도 불량(`WS-DEFECT-COUNT`)에도 카운트되지 않음 (재작업 한도 초과 시에만 불량에 포함). 따라서 `총검사수 ≠ 합격수 + 불량수`인 경우가 발생할 수 있음.

- **미사용 변수**: `WS-CURRENT-LOT`(라인 047)이 선언되었으나 프로그램 내에서 한 번도 참조되지 않음. 데드코드로 판단됨.

- **COPYBOOK 필드 미활용**: `CPYQCRS`의 `QR-MEASURE-VAL`(측정값), `QR-UPPER-LIMIT`(상한), `QR-LOWER-LIMIT`(하한) 필드가 프로그램 내에서 사용되지 않음. 측정값 기반 자동 판정 로직이 구현되어 있지 않으며, 판정코드(`QR-JUDGE-CD`)만 사용.