# PGM003 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM003 |
| 프로그램 목적 | 생산라인에서 발생하는 품질검사 결과를 실시간으로 수신하여 합격/불합격/재작업 판정을 수행하고, 불량률을 산출하여 품질이력을 관리하는 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | QC-RESULT-FILE (QCRSLT) - 품질검사 결과 VSAM 인덱스드 파일 |
| 주요 출력 | QC-HISTORY-FILE (QCHIST) - 품질검사 이력 순차 파일, TB_QC_DAILY_SUMMARY (DB2) - 일일 품질 요약 테이블 |

## 2. 데이터 흐름

### 입력 데이터
- **QC-RESULT-FILE (QCRSLT)**: VSAM 인덱스드 파일. 공장코드+라인코드+검사일자+검사ID를 키로 하는 품질검사 결과 레코드 (COPYBOOK: CPYQCRS)

### 출력 데이터
- **QC-HISTORY-FILE (QCHIST)**: 순차 파일. 검사 건별 최종 판정결과를 기록한 품질이력 레코드 (COPYBOOK: CPYQCHS)
- **TB_QC_DAILY_SUMMARY**: DB2 테이블. 일일 라인별 검사 총건수, 합격수, 불량수, 불량률을 INSERT

### 사용 COPYBOOK
- **CPYQCRS**: 품질검사 결과 레코드 레이아웃 (키: 공장코드/라인코드/검사일자/검사ID, 데이터: 제품코드/LOT번호/판정코드/불량유형/측정값/상하한값/재작업횟수/검사자 등)
- **CPYQCHS**: 품질검사 이력 레코드 레이아웃 (검사ID/라인코드/제품코드/판정코드/검사일자/최종결과)
- **DCLTBQC**: DB2 품질검사 테이블 DCLGEN (소스 미포함)
- **SQLCA**: DB2 SQL 통신 영역

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 처리)
- **목적**: 전체 품질검사 처리 흐름을 제어하는 메인 로직
- **처리 흐름**:
  1. 초기화 (파일 오픈)
  2. 검사 결과 레코드를 EOF까지 반복 처리
  3. 불량률 계산
  4. DB2에 일일 품질 요약 저장
  5. 불량률 기준 경보 판단
  6. 종료 처리 (파일 클로즈)

### 1000-INITIALIZE (초기화)
- **목적**: 입출력 파일을 열고 정상 오픈 여부를 확인
- **처리 흐름**:
  1. QC-RESULT-FILE을 INPUT으로 오픈
  2. QC-HISTORY-FILE을 OUTPUT으로 오픈
  3. 각 파일의 FILE STATUS 확인
  4. 첫 번째 레코드 읽기
- **에러 처리**: 파일 오픈 실패 시(STATUS ≠ '00') 에러 메시지 출력 후 비정상 종료(9900-ABNORMAL-END)

### 2000-PROCESS-INSPECTION (검사 결과 처리)
- **목적**: 개별 검사 결과를 판정코드에 따라 분류 처리
- **처리 흐름**:
  1. 검사 건수 1 증가
  2. 판정코드(QR-JUDGE-CD)에 따라 분기 처리
  3. 이력 파일에 기록
  4. 다음 레코드 읽기
- **조건 분기** (EVALUATE QR-JUDGE-CD):
  - **'P' (합격)**: 합격 건수 증가, 합격 기록 처리
  - **'F' (불합격)**: 불량 건수 증가, 불량 기록 처리
  - **'R' (재작업)**: 재작업 기록 처리
  - **기타**: 유효하지 않은 판정코드 → ERRLOG 프로그램 호출하여 오류 로깅

### 2100-RECORD-PASS (합격 기록)
- **목적**: 합격 판정 시 이전 결과를 'OK'로 설정

### 2200-RECORD-DEFECT (불량 기록)
- **목적**: 불합격 판정 시 불량을 기록하고, 치명적 불량이면 즉시 경보
- **처리 흐름**:
  1. 이전 결과를 'NG'로 설정
  2. 불량유형이 'A'(치명적 불량)이면 QCALERT 프로그램을 호출하여 즉시 경보 발송
- **호출 서브프로그램**: QCALERT - 라인코드, 제품코드, 불량유형을 파라미터로 전달하여 품질 경보 발생

### 2300-RECORD-REWORK (재작업 기록)
- **목적**: 재작업 판정을 기록하되, 재작업 횟수 초과 시 불합격으로 전환
- **처리 흐름**:
  1. 이전 결과를 'RW'로 설정
  2. 재작업 횟수(QR-REWORK-CNT)가 3회 초과이면:
     - 판정코드를 'F'(불합격)로 변경
     - 불량 건수 1 증가
     - ERRLOG에 해당 건을 기록
- **비즈니스 규칙**: 동일 제품에 대한 재작업은 최대 3회까지만 허용. 초과 시 자동 불합격 처리

### 2400-WRITE-HISTORY (이력 기록)
- **목적**: 검사 결과를 품질이력 파일에 기록
- **처리 흐름**: 검사결과 레코드의 주요 필드(검사ID, 라인코드, 제품코드, 판정코드, 검사일자)와 최종 판정결과(OK/NG/RW)를 이력 레코드로 매핑하여 기록

### 3000-CALCULATE-RATE (불량률 계산)
- **목적**: 전체 검사 건수 대비 불량률(%) 산출
- **처리 흐름**:
  - 검사 건수 > 0인 경우: 불량률 = (불량 건수 / 검사 건수) × 100
  - 검사 건수 = 0인 경우: 불량률 = 0 (제로 디비전 방지)

### 4000-UPDATE-QC-SUMMARY (일일 품질 요약 DB2 저장)
- **목적**: 당일 품질 검사 집계 결과를 DB2 테이블에 저장
- **처리 흐름**: TB_QC_DAILY_SUMMARY 테이블에 검사일자(CURRENT DATE), 라인코드, 총검사수, 합격수, 불량수, 불량률을 INSERT
- **에러 처리**: SQLCODE ≠ 0이면 SQLERR 프로그램을 호출하여 SQL 에러 로깅
- **비즈니스 의미**: MES 품질 대시보드 및 일일 품질 리포트의 데이터 소스로 활용

### 5000-CHECK-ALERT (경보 판단)
- **목적**: 불량률 기준에 따라 경보 수준을 결정하고 알림 발생
- **조건 분기**:
  - 불량률 > 5.00% (CRITICAL 임계값): "CRITICAL" 경보 메시지 출력 + QCALERT 프로그램 호출
  - 불량률 > 2.50% (WARNING 임계값): "WARNING" 경보 메시지 출력
  - 그 외: 정상 (경보 없음)
- **호출 서브프로그램**: QCALERT - 라인코드, 제품코드, 불량률을 파라미터로 전달

### 9000-FINALIZE (종료 처리)
- **목적**: 파일 클로즈 및 처리 결과 요약 출력
- **처리 흐름**: 두 파일을 닫고, 총 검사 건수와 불량 건수를 콘솔에 출력

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오류 발생 시 에러 정보 출력 후 프로그램 강제 종료
- **호출 서브프로그램**: ABNDPGM - 파일 상태 코드를 전달하여 비정상 종료 처리

## 4. 비즈니스 규칙 요약

1. **판정 분류**: 검사 결과는 합격(P), 불합격(F), 재작업(R) 3가지로 분류되며, 이외의 코드는 오류로 로깅
2. **재작업 횟수 제한**: 동일 제품의 재작업이 3회를 초과하면 자동으로 불합격(F) 처리
3. **치명적 불량 즉시 경보**: 불량유형 'A'(치명적 불량) 발생 시 건별로 즉시 QCALERT 경보 발생
4. **불량률 산출**: 불량률(%) = (불량 건수 / 총 검사 건수) × 100
5. **불량률 경보 기준 (2단계)**:
   - CRITICAL: 불량률 > 5.00% → 즉시 경보 + QCALERT 호출
   - WARNING: 불량률 > 2.50% → 경고 메시지 출력
6. **일일 품질 요약**: 라인별 일일 검사 집계(총건수/합격수/불량수/불량률)를 DB2에 저장
7. **품질이력 전수 기록**: 모든 검사 건은 최종 판정결과와 함께 이력 파일에 기록

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **품질관리 (QM)** - 실시간 품질검사 결과 처리, 불량률 모니터링, SPC(통계적 공정 관리) 데이터 수집, 품질 경보 발생 |
| 모더나이제이션 시 주의사항 | ① 실시간 경보 로직(QCALERT)의 연계 시스템 파악 필요 ② 재작업 3회 초과 시 자동 불합격 전환 규칙이 현업과 일치하는지 확인 필요 ③ TB_QC_DAILY_SUMMARY 테이블을 참조하는 하위 시스템(리포트, 대시보드) 영향도 분석 필요 ④ ERRLOG/SQLERR/ABNDPGM 등 공통 유틸리티 프로그램의 현대화 방안 검토 |

## 6. 특이사항/리스크

- **하드코딩된 임계값**: CRITICAL 불량률 한도 5.00%, WARNING 한도 2.50%, 재작업 허용 횟수 3회가 WORKING-STORAGE에 하드코딩. 운영 중 기준 변경 시 프로그램 수정/재컴파일 필요 → 설정 파일 또는 DB 테이블 기반 외부화 권장
- **WS-CURRENT-LOT 미사용**: WORKING-STORAGE에 선언된 `WS-CURRENT-LOT`(PIC X(15))이 프로그램 내에서 참조되지 않는 데드 변수
- **단일 라인 집계 한계**: 4000-UPDATE-QC-SUMMARY에서 `QR-LINE-CD`를 사용하지만, 입력 파일에 여러 라인의 검사 결과가 혼재할 경우 마지막으로 읽은 라인코드만 DB2에 저장됨. 라인별 별도 집계 로직이 없어 **다중 라인 데이터 처리 시 부정확한 결과** 발생 가능
- **재작업→불합격 전환 시 합격수 미조정**: 2300-RECORD-REWORK에서 재작업 3회 초과 시 불량 건수는 증가시키지만, 재작업이 기존에 합격/불량 어디에도 카운트되지 않으므로 총건수(검사수) = 합격수 + 불량수가 성립하지 않음 (재작업 건은 합격수에도 불량수에도 포함되지 않다가, 3회 초과 시에만 불량수에 가산)
- **DB2 INSERT 중복 가능성**: 동일 일자/라인에 대해 프로그램을 재실행하면 TB_QC_DAILY_SUMMARY에 중복 레코드가 INSERT됨. UPSERT(MERGE) 또는 사전 삭제 로직이 없음
- **FILE STATUS 변수 공유**: WS-FILE-STATUS가 QC-RESULT-FILE에만 연결되어 있으나, 두 파일 오픈 검증을 별도 변수(WS-FILE-STATUS, WS-FILE-STATUS2)로 분리한 것은 양호. 다만 READ/WRITE 시 FILE STATUS 검증이 누락되어 있음