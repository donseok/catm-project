# PGM005 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM005 |
| 프로그램 목적 | 고로(용광로)의 일일 조업 데이터를 수집하여 온도/압력/출선량 등 핵심 지표를 통계 산출하고, 이상치 발생 시 경보를 발행하며 일일 조업일보를 생성하는 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | 고로 조업 데이터 파일(BF-OPER-FILE), 고로 온도 측정 파일(BF-TEMP-FILE) |
| 주요 출력 | 일일 조업일보 파일(DAILY-REPORT-FILE), DB2 테이블(TB_BF_DAILY_OPER) |

## 2. 데이터 흐름

### 입력 데이터
- **BF-OPER-FILE (BFOPER)**: 고로 조업 데이터 VSAM 색인파일 — 고로번호+조업일자+순번을 키로 하여 조업유형, 압력, 풍량, 코크스비, 출선량 등을 보유
- **BF-TEMP-FILE (BFTEMP)**: 고로 온도 측정 VSAM 색인파일 — 고로번호+측정일자+순번을 키로 하여 센서별 온도값을 보유

### 출력 데이터
- **DAILY-REPORT-FILE (BFDAILY)**: 일일 조업일보 순차파일 — 고로별 일일 평균/최고/최저 온도, 평균 압력, 총 출선량, 경보 건수, 상태코드 기록
- **TB_BF_DAILY_OPER**: DB2 테이블 — 일일 조업 통계를 INSERT하여 이력 관리

### 사용 COPYBOOK
- **CPYBFOP**: 고로 조업 데이터 레코드 구조 (조업유형, 교대, 압력, 풍량, 코크스비, 출선량, 슬래그량 등)
- **CPYBFTM**: 고로 온도 측정 레코드 구조 (온도값, 센서ID, 측정위치, 측정방식, 상태코드)
- **DCLTBBFOP**: DB2 테이블 TB_BF_DAILY_OPER의 DCLGEN (SQL 호스트 변수)

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 처리)
- **목적**: 전체 처리 흐름을 제어하는 메인 로직
- **처리 흐름**:
  1. 초기화(파일 열기)
  2. 조업 데이터를 EOF까지 반복 처리
  3. 일일 통계 산출
  4. 이상치 종합 판정
  5. 일일 조업일보 파일 출력
  6. DB2 테이블 갱신
  7. 종료 처리(파일 닫기)

### 1000-INITIALIZE (초기화)
- **목적**: 입출력 파일을 열고 정상 여부를 확인
- **처리 흐름**:
  1. 조업 데이터 파일(입력), 온도 측정 파일(입력), 일일 보고서 파일(출력)을 각각 OPEN
  2. 파일 오픈 상태 확인 후 오류 시 비정상 종료
  3. 첫 번째 조업 레코드 READ
- **에러 처리**: 파일 오픈 실패 시 상태코드를 출력하고 9900-ABNORMAL-END 호출

### 2000-PROCESS-OPER-DATA (조업 데이터 처리)
- **목적**: 개별 조업 레코드를 읽어 온도 조회, 데이터 누적, 출선 처리를 수행
- **처리 흐름**:
  1. 읽기 건수 카운트 증가
  2. 현재 고로번호 저장
  3. 해당 조업의 온도 데이터 조회 (2100)
  4. 압력 등 데이터 누적 (2200)
  5. 조업유형이 'T'(출선)이면 출선량 누적 (2300)
  6. 다음 레코드 READ
- **조건 분기**: 조업유형 = 'T'(출선)인 경우에만 출선량 집계 수행

### 2100-GET-TEMPERATURE (온도 데이터 조회)
- **목적**: 조업 레코드에 대응하는 온도 측정값을 온도 파일에서 랜덤 조회
- **처리 흐름**:
  1. 조업 레코드의 고로번호, 조업일자, 순번으로 온도 파일 키를 구성
  2. 온도 파일 랜덤 READ
  3. 키 매칭 실패 시 오류 건수 증가 및 ERRLOG 호출
  4. 키 매칭 성공 시 온도 범위 점검 수행
- **호출 서브프로그램**: `ERRLOG` — 온도 데이터 미존재 시 오류 로깅 (고로번호, 조업일자 전달)
- **에러 처리**: INVALID KEY 발생 시 오류 카운트 증가 후 계속 처리

### 2110-CHECK-TEMP-RANGE (온도 범위 점검)
- **목적**: 측정 온도를 누적하고 정상 범위를 벗어나면 경보 발행
- **처리 흐름**:
  1. 온도값을 합계에 누적
  2. 최고/최저 온도 갱신
  3. 상한(1,650.0°C) 초과 시 경보 카운트 증가 및 BFALERT 호출
  4. 하한(1,400.0°C) 미만 시 경보 카운트 증가 및 BFALERT 호출
- **비즈니스 의미**: 고로 내부 온도가 정상 범위(1,400~1,650°C)를 벗어나면 설비 안전 및 제품 품질에 직접적인 영향이 있으므로 즉시 경보를 발행
- **호출 서브프로그램**: `BFALERT` — 고로번호, 실측 온도값, 한계값을 전달하여 경보 발행

### 2200-ACCUMULATE-DATA (압력 데이터 누적)
- **목적**: 압력 데이터를 누적하고 상한 초과 시 경보 발행
- **처리 흐름**:
  1. 압력값을 합계에 누적
  2. 압력 상한(3.50 kgf/cm²) 초과 시 경보 발행
- **호출 서브프로그램**: `BFALERT` — 고로번호, 실측 압력값, 한계값 전달

### 2300-PROCESS-TAPPING (출선 처리)
- **목적**: 출선(용선 배출) 작업의 출선량을 누적
- **처리 흐름**: 출선량(BO-TAP-QTY)을 일일 총 출선량에 가산

### 3000-CALC-DAILY-STATS (일일 통계 산출)
- **목적**: 수집된 데이터로 일일 평균 온도를 계산
- **처리 흐름**: 읽기 건수가 0보다 크면 온도 합계 ÷ 읽기 건수로 평균 온도 산출
- **조건 분기**: 읽기 건수 = 0인 경우 0으로 나누기 방지

### 4000-CHECK-ABNORMAL (이상치 종합 판정)
- **목적**: 하루 동안의 총 경보 건수를 기준으로 위험 수준을 판정
- **처리 흐름**: 경보 건수 > 10이면 **CRITICAL** 등급으로 판정하고 BFALERT 호출
- **비즈니스 의미**: 10건 초과의 경보가 발생한 고로는 조업 중단 또는 특별 점검 대상
- **호출 서브프로그램**: `BFALERT` — 고로번호, 경보 건수, 최고 온도 전달

### 5000-WRITE-DAILY-REPORT (일일 조업일보 출력)
- **목적**: 산출된 통계를 일일 조업일보 레코드로 작성
- **처리 흐름**:
  1. 고로번호, 조업일자, 평균/최고/최저 온도 설정
  2. 평균 압력 산출 (압력 합계 ÷ 읽기 건수)
  3. 총 출선량, 경보 건수 설정
  4. 상태코드 결정 후 레코드 기록
- **조건 분기 (상태코드)**:
  - 경보 > 10건 → **'CR'** (Critical, 위험)
  - 경보 1~10건 → **'WN'** (Warning, 주의)
  - 경보 0건 → **'OK'** (정상)

### 6000-UPDATE-DB2 (DB2 갱신)
- **목적**: 일일 조업 통계를 DB2 테이블 TB_BF_DAILY_OPER에 INSERT하여 이력으로 관리
- **처리 흐름**: 고로번호, 조업일자, 평균/최고/최저 온도, 출선량, 경보 건수, 상태코드를 INSERT
- **비즈니스 의미**: 일일 조업 이력을 DB2에 저장하여 장기 추세 분석 및 보고서 작성에 활용
- **호출 서브프로그램**: `SQLERR` — SQLCODE가 0이 아닌 경우 SQL 오류 처리 모듈 호출
- **에러 처리**: SQLCODE ≠ 0 시 SQLERR 호출

### 9000-FINALIZE (종료 처리)
- **목적**: 모든 파일을 닫고 처리 결과를 표시
- **처리 흐름**: 3개 파일 CLOSE, 고로번호·처리건수·경보건수 출력

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오류 등 복구 불가능한 오류 발생 시 프로그램을 비정상 종료
- **호출 서브프로그램**: `ABNDPGM` — 파일 상태코드를 전달하여 비정상 종료 처리

## 4. 비즈니스 규칙 요약

1. **온도 정상 범위**: 고로 온도는 1,400.0°C ~ 1,650.0°C가 정상 범위이며, 이탈 시 즉시 경보(BFALERT) 발행
2. **압력 상한**: 고로 내 압력이 3.50 kgf/cm² 초과 시 경보 발행
3. **출선량 집계**: 조업유형이 'T'(출선)인 레코드에 대해서만 출선량을 누적 집계
4. **위험 등급 판정**: 일일 경보 건수 기준으로 3단계 상태 분류
   - 10건 초과 → CR (위험, 특별 점검 대상)
   - 1~10건 → WN (주의)
   - 0건 → OK (정상)
5. **위험 고로 에스컬레이션**: 경보 10건 초과 시 CRITICAL 메시지 출력 및 추가 경보 호출
6. **온도 데이터 불일치 관리**: 조업 레코드에 대응하는 온도 측정 데이터가 없을 경우 오류 로깅(ERRLOG) 후 처리 계속
7. **이중 저장**: 조업일보는 순차파일과 DB2 테이블 양쪽에 저장하여 데이터 이중화

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **공정관리** (고로 조업 모니터링), **설비관리** (온도/압력 이상 감시), **생산관리** (출선량 집계) |
| 모더나이제이션 시 주의사항 | ① 온도/압력 임계값(1400, 1650, 3.50)은 운영 환경에 따라 변동 가능하므로 설정 테이블화 필요 ② BFALERT 경보 모듈의 후속 처리(알림, 인터록 등) 연계 범위 확인 필수 ③ 실시간 모니터링 시스템으로 전환 시 배치→이벤트 드리븐 아키텍처 검토 ④ DB2 INSERT만 존재하여 중복 실행 시 PK 충돌 가능 — UPSERT 로직 또는 멱등성 확보 필요 |

## 6. 특이사항/리스크

- **매직넘버 하드코딩**: 온도 상한(1,650.0), 온도 하한(1,400.0), 압력 상한(3.50), 위험 판정 기준(10건)이 모두 WORKING-STORAGE에 하드코딩됨 → 설정 파일 또는 테이블로 외부화 필요
- **단일 고로 전제**: `WS-CURRENT-BF`가 마지막 읽은 고로번호로 덮어써지므로, 파일에 여러 고로의 데이터가 섞여 있으면 통계가 부정확해짐 → 고로별 BREAK 처리 로직 부재
- **평균 압력 계산 위치 불일치**: `DR-COKE-RATE` 필드가 일일 보고서 레코드에 정의되어 있으나 실제로 값이 설정되지 않음 (초기값 상태로 출력됨)
- **DB2 INSERT 전용**: UPDATE/UPSERT 로직이 없어 동일 일자 재실행 시 PK 중복 에러 발생 가능
- **온도 파일 미매칭 시 통계 왜곡**: 온도 데이터를 찾지 못한 건도 `WS-READ-COUNT`에 포함되므로 평균 온도가 실제보다 낮게 산출될 수 있음 (온도 합계에 미반영되지만 분모에는 포함)
- **파일 상태 변수 공유 우려**: `WS-FILE-STATUS`를 BF-OPER-FILE에 사용하나, 초기화 시 BF-TEMP-FILE 상태는 `WS-FILE-STATUS2`로 별도 확인 — 일관성은 유지되나 변수명만으로는 혼동 가능
- **외부 모듈 의존**: ERRLOG, BFALERT, SQLERR, ABNDPGM 등 4개 외부 서브프로그램에 의존하며, 이들의 동작이 문서화되어 있지 않으면 전체 처리 흐름 파악에 제한