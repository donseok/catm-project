# PGM006 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM006 |
| 프로그램 목적 | 원자재 입고 전표를 순차적으로 읽어 검수 결과(합격/부분합격/불합격)에 따라 재고를 반영하고, 불합격 자재는 반품 파일에 기록하며, 일일 입고 실적을 DB2에 집계하는 배치 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | 원자재 입고 전표 파일(RMRCPT), 원자재 마스터 파일(RMMAST) |
| 주요 출력 | 반품 파일(RMRETN), DB2 일일 입고 실적 테이블(TB_RM_DAILY_RECEIPT), 갱신된 원자재 마스터 |

## 2. 데이터 흐름

### 입력 데이터
- **RM-RECEIPT-FILE (RMRCPT)**: 원자재 입고 전표 — INDEXED/SEQUENTIAL 읽기, COPYBOOK `CPYRMRC` 구조
- **RM-MASTER-FILE (RMMAST)**: 원자재 마스터 — INDEXED/RANDOM 접근, COPYBOOK `CPYRMMS` 구조

### 출력 데이터
- **RETURN-FILE (RMRETN)**: 반품 대상 자재 기록 — SEQUENTIAL 출력
- **TB_RM_DAILY_RECEIPT**: DB2 테이블 — 일일 입고/합격/불합격/부분합격 건수 및 금액 집계

### 사용 COPYBOOK
- **CPYRMRC**: 원자재 입고 전표 레코드 구조 (입고번호, 입고일자, 자재코드, 검수코드, 합격률, 사유코드 등)
- **CPYRMMS**: 원자재 마스터 레코드 구조 (자재코드, 단가, 재고수량, 안전재고, 최종입고일 등)
- **SQLCA**: DB2 SQL 통신 영역
- **DCLTBRM**: DB2 테이블 선언 (TB_RM_DAILY_RECEIPT 관련 추정)

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 제어)
- **목적**: 프로그램 전체 흐름 제어
- **처리 흐름**:
  1. 초기화 수행 (파일 오픈, 첫 레코드 읽기)
  2. 입고 전표를 EOF까지 반복 처리
  3. 일일 실적을 DB2에 집계 저장
  4. 종료 처리 (파일 닫기, 처리 결과 출력)

### 1000-INITIALIZE (초기화)
- **목적**: 3개 파일 오픈 및 정상 여부 확인
- **처리 흐름**:
  1. 입고 전표 파일을 INPUT으로 오픈
  2. 원자재 마스터 파일을 I-O(읽기/쓰기)로 오픈
  3. 반품 파일을 OUTPUT으로 오픈
  4. 파일 상태 확인 후 첫 번째 입고 전표 읽기
- **에러 처리**: 입고 전표 또는 마스터 파일 오픈 실패 시 에러 메시지 출력 후 비정상 종료(9900-ABNORMAL-END)

### 1100-READ-FIRST-RECORD (첫 레코드 읽기)
- **목적**: 입고 전표 파일에서 첫 번째 레코드를 읽어 처리 루프 진입 준비
- **처리 흐름**: 레코드가 없으면 EOF 플래그 설정

### 2000-PROCESS-RECEIPT (입고 전표 처리)
- **목적**: 개별 입고 전표를 검수 결과에 따라 분기 처리
- **처리 흐름**:
  1. 입고 건수 1 증가
  2. 입고 전표의 자재코드로 마스터 파일에서 해당 자재 조회
  3. 마스터에 존재하면 검수 처리(2100) 수행
  4. 다음 입고 전표 읽기
- **에러 처리**: 마스터에 자재코드가 없으면 `ERRLOG` 서브프로그램 호출 후 에러 건수 증가
- **호출 서브프로그램**: `ERRLOG` — 존재하지 않는 자재코드에 대한 오류 기록

### 2100-INSPECT-MATERIAL (검수 판정 분기)
- **목적**: 검수코드(RR-INSPECT-CD)에 따라 합격/부분합격/불합격 처리 분기
- **조건 분기**:
  | 검수코드 | 의미 | 처리 |
  |---------|------|------|
  | `'A'` | 전량 합격 | 2200-ACCEPT-FULL |
  | `'P'` | 부분 합격 | 2300-ACCEPT-PARTIAL |
  | `'R'` | 전량 불합격 | 2400-REJECT-MATERIAL |
  | 기타 | 잘못된 코드 | ERRLOG 호출 + 에러 건수 증가 |

### 2200-ACCEPT-FULL (전량 합격 처리)
- **목적**: 입고 수량 전체를 재고에 반영
- **처리 흐름**:
  1. 입고 수량을 마스터 재고수량에 가산
  2. 최종 입고일자를 갱신
  3. 합격 금액 누계 = 입고수량 × 단가
  4. 입고 금액 누계 = 입고수량 × 단가
  5. 합격 건수 1 증가
  6. 마스터 레코드 갱신(REWRITE)
- **비즈니스 의미**: 검수 통과된 자재가 즉시 가용 재고로 편입됨

### 2300-ACCEPT-PARTIAL (부분 합격 처리)
- **목적**: 합격률에 따라 일부만 재고 반영, 나머지는 반품 처리
- **처리 흐름**:
  1. 합격 수량 = 입고수량 × 합격률 / 100
  2. 불합격 수량 = 입고수량 - 합격 수량
  3. 합격 수량만 마스터 재고에 가산
  4. 최종 입고일자 갱신
  5. 합격 금액 누계 가산 (합격수량 × 단가)
  6. 입고 금액 누계 가산 (전체 입고수량 × 단가)
  7. 부분합격 건수 1 증가
  8. 마스터 레코드 갱신
  9. 불합격 수량에 대해 반품 파일 기록(2410)
- **비즈니스 의미**: 자재 중 일부만 품질 기준 충족 시, 합격분은 재고 투입하고 불합격분은 반품 처리

### 2400-REJECT-MATERIAL (전량 불합격 처리)
- **목적**: 입고 자재 전량을 반품 처리 (재고 반영 없음)
- **처리 흐름**:
  1. 전체 입고수량을 불합격 수량으로 설정
  2. 반품 금액 누계 가산 (입고수량 × 단가)
  3. 불합격 건수 1 증가
  4. `MATRETN` 서브프로그램 호출 (자재코드, 공급업체, 수량 전달)
  5. 반품 파일에 기록(2410)
- **호출 서브프로그램**: `MATRETN` — 반품 처리 전문 모듈 (공급업체 통보 또는 반품 전표 생성 추정)
- **비즈니스 의미**: 품질 기준 미달 자재는 재고에 편입하지 않고 공급업체에 반품

### 2410-WRITE-RETURN (반품 레코드 기록)
- **목적**: 반품 대상 자재 정보를 반품 파일에 출력
- **처리 흐름**:
  1. 반품 레코드 초기화
  2. 자재코드, 입고번호, 반품수량, 사유코드, 공급업체코드, 입고일자를 이동
  3. 반품 파일에 기록

### 3000-UPDATE-SUMMARY (일일 실적 DB2 저장)
- **목적**: 당일 입고 처리 결과를 DB2 테이블에 집계 저장
- **처리 흐름**:
  1. `TB_RM_DAILY_RECEIPT` 테이블에 INSERT
     - 입고일자: 현재일자(CURRENT DATE)
     - 입고건수, 합격건수, 불합격건수, 부분합격건수
     - 총입고금액, 합격금액, 반품금액
  2. SQL 에러 시 `SQLERR` 서브프로그램 호출
- **DB2 비즈니스 의미**: 일일 원자재 입고 실적을 경영 보고용으로 축적하여, 입고 추세 분석 및 품질 관리 지표로 활용
- **호출 서브프로그램**: `SQLERR` — SQL 오류 처리 모듈

### 9000-FINALIZE (종료 처리)
- **목적**: 파일 닫기 및 처리 결과 요약 출력
- **처리 흐름**:
  1. 3개 파일 모두 닫기
  2. 총 입고건수, 합격건수, 불합격건수 출력

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오픈 실패 등 치명적 오류 시 프로그램 강제 종료
- **처리 흐름**: 파일 상태 코드 출력 후 `ABNDPGM` 서브프로그램 호출 → STOP RUN
- **호출 서브프로그램**: `ABNDPGM` — 비정상 종료 처리 모듈

## 4. 비즈니스 규칙 요약

1. **검수코드 'A'(전량합격)**: 입고 수량 전체가 마스터 재고에 즉시 반영된다
2. **검수코드 'P'(부분합격)**: 합격률(RR-ACCEPT-RATE)에 따라 합격 수량만 재고에 반영하고, 나머지는 반품 처리한다
3. **검수코드 'R'(전량불합격)**: 재고에 반영하지 않고 전량 반품 처리하며, MATRETN 모듈을 통해 공급업체 반품 절차를 진행한다
4. **마스터 미등록 자재**: 입고 전표의 자재코드가 마스터에 없으면 에러 처리하고 입고를 건너뛴다
5. **금액 계산 기준**: 모든 금액은 마스터의 단가(RM-UNIT-PRICE)를 기준으로 산출한다 (입고 전표의 단가가 아님)
6. **입고 금액 누계**: 합격/부분합격 모두 전체 입고수량 기준 금액을 총입고금액에 포함하며, 전량불합격은 반품금액에만 집계한다
7. **최종 입고일자**: 합격 또는 부분합격 시에만 마스터의 최종입고일자(RM-LAST-IN-DT)를 갱신한다
8. **반품 사유코드**: QL(품질불량), DM(파손), SP(규격불일치), MS(수분과다) 4종으로 관리한다
9. **원자재 카테고리**: 철광석(IO), 석탄(CL), 석회석(LS), 합금철(FA), 고철(SC) 5종으로 분류한다
10. **일일 실적 집계**: 처리 완료 후 당일 입고/합격/불합격/부분합격 건수와 금액을 DB2에 저장한다

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **재고관리** (원자재 입고→재고 반영), **품질관리** (입고 검수 판정 및 불합격 반품), **구매/조달관리** (공급업체별 반품 처리) |
| 모더나이제이션 시 주의사항 | ① 검수코드 3종(A/P/R) 분기 로직이 핵심이므로 현대화 시 상태 머신 패턴으로 설계 권장 ② 부분합격 시 합격률 계산의 소수점 처리(COMP-3, V99)를 현대 언어에서 정확히 재현해야 함 ③ MATRETN 외부 모듈 의존성 파악 필요 ④ DB2 INSERT가 일일 1회 가정이므로 중복 실행 방지 로직 추가 필요 |

## 6. 특이사항/리스크

- **PERFORM WITH 구문 오류 (line 161-162, 173-174)**: `PERFORM 2410-WRITE-RETURN WITH WS-REJECT-QTY RR-REASON-CD` 구문은 표준 COBOL에서 유효하지 않음. `PERFORM ... THRU`나 파라미터 전달 방식과 혼동된 것으로 보이며, 실제 2410-WRITE-RETURN은 WORKING-STORAGE의 WS-REJECT-QTY 값을 직접 참조하므로 동작에는 영향이 없을 수 있으나, 컴파일러별 동작 차이 리스크가 있음
- **반품 파일(RETURN-FILE) 오픈 상태 미검증**: WS-FILE-STATUS3를 선언했으나 오픈 후 상태 확인을 하지 않아, 반품 파일 오픈 실패 시 무시되고 WRITE에서 런타임 오류 발생 가능
- **전량불합격 시 입고금액 미집계**: 전량불합격(2400) 시 WS-TOTAL-RECEIPT-AMT에 가산하지 않아, 일일 실적의 총입고금액이 실제 입고 총액보다 작을 수 있음 (의도적인 설계인지 확인 필요)
- **DB2 중복 INSERT 방지 없음**: 같은 날짜에 프로그램을 재실행하면 TB_RM_DAILY_RECEIPT에 중복 행이 삽입됨. MERGE 또는 사전 DELETE 로직이 없음
- **파일 CLOSE 후 에러 미확인**: 9000-FINALIZE에서 3개 파일 CLOSE 후 파일 상태를 확인하지 않음
- **매직넘버**: 합격률 나누기 `100` (line 148)이 하드코딩되어 있으나, 퍼센트 계산이므로 업무상 합리적인 상수
- **SQLCA/DCLTBRM INCLUDE**: DB2 관련 INCLUDE가 WORKING-STORAGE에 있어 정상이나, DCLTBRM의 실제 구조가 소스에 포함되지 않아 DB2 테이블 컬럼과의 매핑 검증이 필요