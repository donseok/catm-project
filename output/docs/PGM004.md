# PGM004 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM004 |
| 프로그램 목적 | 월별 생산계획 대비 실적을 비교하여 달성율을 산출하고, 미달 품목에 대해 생산지시 알림을 발행하는 생산실적 분석 배치 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | 생산계획 파일(PRDPLAN, VSAM KSDS), 생산실적 파일(PRDACT, VSAM KSDS) |
| 주요 출력 | 계획대비실적 결과 파일(PLNRSLT, 순차파일), DB2 요약 테이블(TB_PROD_PLAN_RESULT) |

## 2. 데이터 흐름

### 입력 데이터
- **PROD-PLAN-FILE (PRDPLAN)**: VSAM 색인 순차파일. 공장별·품목별·월별 생산계획 수량을 보유. COPYBOOK `CPYPPLAN` 구조 사용. 키 = 공장코드(4) + 품목코드(15) + 년월(6)
- **PROD-ACTUAL-FILE (PRDACT)**: VSAM 색인 랜덤파일. 품목별·월별 생산실적 수량을 보유. COPYBOOK `CPYPACT` 구조 사용. 키 = 품목코드(15) + 년월(6)

### 출력 데이터
- **PLAN-RESULT-FILE (PLNRSLT)**: 순차파일. 품목별 계획수량, 실적수량, 달성율, 차이수량, 판정코드를 기록
- **TB_PROD_PLAN_RESULT**: DB2 테이블. 월별 전체 요약 정보(총계획, 총실적, 달성율, 달성/미달/초과 건수) INSERT

### 사용 COPYBOOK
- **CPYPPLAN**: 월별 생산계획 레코드 구조 — 공장코드, 품목코드, 년월, 계획수량, 단위, 라인, 우선순위, 계획유형, 등록정보 포함
- **CPYPACT**: 월별 생산실적 레코드 구조 — 품목코드, 년월, 실적수량, 근무일수, 라인수, 불량수량, 수율, 최종갱신일 포함

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 제어)
- **목적**: 프로그램 전체 처리 흐름을 제어하는 주 프로세스
- **처리 흐름**:
  1. 초기화(파일 오픈)
  2. 계획파일 EOF까지 계획 대비 실적 비교를 반복 수행
  3. 전체 달성율 산출
  4. DB2 요약 테이블에 결과 저장
  5. 미달 시 생산지시 알림 발행
  6. 종료 처리(파일 클로즈)

### 1000-INITIALIZE (초기화)
- **목적**: 3개 파일(계획/실적/결과)을 열고, 파일 상태를 점검한 후 첫 레코드를 읽음
- **처리 흐름**:
  1. 생산계획 파일을 INPUT으로 OPEN
  2. 생산실적 파일을 INPUT으로 OPEN
  3. 결과 파일을 OUTPUT으로 OPEN
  4. 계획파일 상태코드가 '00'이 아니면 비정상 종료
  5. 실적파일 상태코드가 '00'이 아니면 비정상 종료
  6. 첫 번째 계획 레코드 읽기
- **에러 처리**: 파일 오픈 실패 시 상태코드를 DISPLAY하고 `9900-ABNORMAL-END`로 분기

### 1100-READ-FIRST-RECORD (첫 레코드 읽기)
- **목적**: 생산계획 파일의 첫 번째 레코드를 읽어 반복 처리의 시작점을 설정
- **처리 흐름**: READ 후 파일 끝이면 EOF 플래그 설정

### 2000-COMPARE-PLAN-ACTUAL (계획 대비 실적 비교)
- **목적**: 개별 품목에 대해 생산계획과 실적을 매칭하여 달성율을 계산하고 결과를 기록
- **처리 흐름**:
  1. 계획 건수 카운터를 1 증가
  2. 계획 레코드의 품목코드와 년월을 실적파일의 키로 설정
  3. 실적파일에서 해당 키로 랜덤 READ 시도
  4. 매칭 실패(INVALID KEY) → `2100-NO-ACTUAL-DATA` 수행
  5. 매칭 성공(NOT INVALID KEY) → `2200-CALC-ACHIEVEMENT` 수행
  6. 다음 계획 레코드 읽기 (EOF 시 플래그 설정)
- **조건 분기**: 실적 데이터 존재 여부에 따라 "실적 없음 처리"와 "달성율 계산"으로 분기

### 2100-NO-ACTUAL-DATA (실적 데이터 없음 처리)
- **목적**: 계획은 있으나 실적이 없는 품목을 "미달(S)" 판정하고 에러 로그를 기록
- **처리 흐름**:
  1. 실적수량, 달성율을 0으로 설정
  2. 차이수량에 계획수량 전체를 설정 (100% 미달)
  3. 판정코드 = 'S' (Shortfall)
  4. 미달 건수 카운터 1 증가
  5. 총 계획수량 누적
  6. 결과 레코드를 파일에 WRITE
  7. `ERRLOG` 서브프로그램 호출하여 품목코드와 년월 로그 기록
- **호출 서브프로그램**: `ERRLOG` — 실적 없는 품목에 대한 에러 로그 기록

### 2200-CALC-ACHIEVEMENT (달성율 계산)
- **목적**: 계획 대비 실적의 달성율을 산출하고, 임계값 기준으로 달성/미달/초과를 판정
- **처리 흐름**:
  1. 총 계획수량, 총 실적수량을 누적
  2. 결과 레코드에 품목코드, 계획수량, 실적수량 설정
  3. 달성율 계산: `(실적수량 / 계획수량) × 100`
     - 계획수량이 0이면 달성율 100%로 처리 (제로 디비전 방지)
  4. 차이수량 계산: `계획수량 - 실적수량`
  5. 판정코드 결정:
     - 달성율 ≥ 120% → 'O' (Over, 초과달성) + 초과 카운터 증가
     - 달성율 ≥ 90% → 'A' (Achieve, 정상달성) + 달성 카운터 증가
     - 달성율 < 90% → 'S' (Shortfall, 미달) + 미달 카운터 증가
  6. 결과 레코드를 파일에 WRITE
- **조건 분기**: EVALUATE문으로 3단계 판정 (초과 → 달성 → 미달)

### 3000-CALC-TOTAL-RATE (전체 달성율 산출)
- **목적**: 모든 품목의 종합 달성율을 계산
- **처리 흐름**: `(총실적수량 / 총계획수량) × 100`
  - 총 계획수량이 0이면 달성율을 0으로 설정

### 4000-UPDATE-DB2-SUMMARY (DB2 요약 저장)
- **목적**: 월별 생산계획 대비 실적 분석 요약 결과를 DB2 테이블에 저장
- **처리 흐름**:
  1. `TB_PROD_PLAN_RESULT` 테이블에 INSERT
     - 계획월, 총계획수량, 총실적수량, 달성율, 달성건수, 미달건수, 초과건수
  2. SQLCODE가 0이 아니면 `SQLERR` 호출
- **에러 처리**: SQL 오류 시 `SQLERR` 서브프로그램에 SQLCODE 전달
- **호출 서브프로그램**: `SQLERR` — SQL 에러 처리 공통 모듈

### 5000-NOTIFY-SHORTFALL (미달 알림 발행)
- **목적**: 전체 달성율이 기준(90%) 미만일 경우 생산지시 알림을 발행
- **처리 흐름**:
  1. 전체 달성율이 90% 미만인지 확인
  2. 미만이면 DISPLAY로 경고 메시지 출력
  3. `PRDNOTI` 서브프로그램 호출하여 달성율과 미달 건수 전달
- **조건 분기**: 달성율 < 90%인 경우에만 알림 발행
- **호출 서브프로그램**: `PRDNOTI` — 생산지시 알림 발행 (메일/메시지 등 추정)

### 9000-FINALIZE (종료 처리)
- **목적**: 모든 파일을 닫고 처리 결과 요약을 출력
- **처리 흐름**:
  1. 3개 파일 CLOSE
  2. 처리 건수, 달성율, 미달 건수, 초과 건수를 DISPLAY

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오픈 등 치명적 오류 발생 시 프로그램을 강제 종료
- **처리 흐름**:
  1. 파일 상태코드를 DISPLAY
  2. `ABNDPGM` 서브프로그램 호출
  3. STOP RUN으로 즉시 종료
- **호출 서브프로그램**: `ABNDPGM` — 비정상 종료 처리 공통 모듈

## 4. 비즈니스 규칙 요약

1. **달성율 산출 공식**: (실적수량 ÷ 계획수량) × 100. 계획수량이 0이면 달성율 100%로 간주
2. **3단계 판정 기준**:
   - 달성율 ≥ 120% → 초과달성(O)
   - 달성율 ≥ 90% → 정상달성(A)
   - 달성율 < 90% → 미달(S)
3. **실적 미존재 품목**: 달성율 0%, 판정코드 'S'(미달), 차이수량 = 계획수량 전체, 에러 로그(ERRLOG) 기록
4. **생산지시 알림 조건**: 전체 종합 달성율이 90% 미만이면 PRDNOTI 서브프로그램으로 알림 발행
5. **DB2 요약 저장**: 처리 완료 후 월별 요약 결과를 TB_PROD_PLAN_RESULT 테이블에 1건 INSERT
6. **매칭 방식**: 생산계획 파일을 순차적으로 읽으면서, 품목코드+년월을 키로 실적파일에서 랜덤 READ 수행

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **생산관리** (생산계획 수립 및 실적 추적, 달성율 모니터링), **공정관리** (라인별 생산실적 분석 기반) |
| 모더나이제이션 시 주의사항 | ① MES 시스템의 생산계획 모듈과 실적 수집 모듈 간 실시간 연계로 전환 시 배치→실시간 아키텍처 변경 필요 ② 달성율 임계값(90%, 120%)이 하드코딩되어 있으므로 설정 테이블로 외부화 필요 ③ PRDNOTI 알림 발행의 구체적 채널(메일/SMS/MQ 등)을 파악하여 현대화된 알림 시스템으로 대체 필요 ④ VSAM→RDBMS 전환 시 계획파일의 키 구조(공장+품목+년월)와 실적파일의 키 구조(품목+년월)가 다름에 주의 |

## 6. 특이사항/리스크

- **하드코딩된 임계값**: 달성 기준 90%(`WS-ACHIEVE-THRESHOLD = 090`), 초과 기준 120%(`WS-OVER-THRESHOLD = 120`)이 WORKING-STORAGE에 고정값으로 정의됨. 운영 환경에서 변경 시 소스 수정 및 재컴파일 필요
- **키 구조 불일치**: 생산계획 파일 키는 공장코드(4)+품목코드(15)+년월(6)이나, 실적 파일 키는 품목코드(15)+년월(6)으로 공장코드가 없음. 동일 품목이 복수 공장에서 생산될 경우 실적이 공장별로 분리되지 않아 데이터 정합성 문제 발생 가능
- **DB2 INSERT 중복 위험**: `4000-UPDATE-DB2-SUMMARY`에서 INSERT만 수행하므로, 동일 월에 프로그램을 재실행하면 중복 레코드가 생성됨. MERGE(UPSERT) 또는 사전 DELETE 로직이 없음
- **파일 상태 변수 혼용 우려**: `WS-FILE-STATUS`가 PROD-PLAN-FILE과 PLAN-RESULT-FILE 모두의 상태를 반영할 수 있음 (PLAN-RESULT-FILE의 FILE STATUS가 `WS-FILE-STATUS3`로 별도 지정되어 있으나, 결과 파일 OPEN 후 상태 점검 로직이 누락됨)
- **결과 파일 WRITE 오류 미처리**: `PLAN-RESULT-REC` WRITE 시 오류 처리(INVALID KEY, FILE STATUS 확인)가 없음
- **ERRLOG 호출 제한**: 실적 없는 품목에 대해서만 ERRLOG를 호출하며, 달성율 미달(실적은 있으나 90% 미만)인 품목에 대해서는 개별 로그가 기록되지 않음
- **PP-YYYYMM 참조 시점**: `4000-UPDATE-DB2-SUMMARY`에서 `:PP-YYYYMM`을 참조하는데, 이 시점에서 PP-YYYYMM은 마지막으로 읽은 계획 레코드의 값 또는 EOF 직전 레코드의 값임. 복수 월 데이터가 섞여 있으면 의도하지 않은 월이 기록될 수 있음