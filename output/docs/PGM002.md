# PGM002 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM002 |
| 프로그램 목적 | 입출고 트랜잭션을 순차적으로 처리하여 재고 마스터를 실시간 갱신하고, 수불대장(재고 이동 원장)을 생성하는 재고수불 일일배치 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | 입출고 트랜잭션 파일(INVTRAN, VSAM KSDS), 재고 마스터 파일(INVMAST, VSAM KSDS) |
| 주요 출력 | 수불대장 파일(INVLEDG, Sequential), DB2 일일처리 요약 테이블(TB_INV_SUMMARY) |

## 2. 데이터 흐름

### 입력 데이터
- **INV-TRANS-FILE (INVTRAN)**: 재고 입출고 트랜잭션 파일 (VSAM KSDS, 순차 읽기). COPYBOOK `CPYINVTR` 구조 사용. 키: 공장코드+품목코드+거래일자+순번
- **INV-MASTER-FILE (INVMAST)**: 재고 마스터 파일 (VSAM KSDS, 랜덤 I/O). COPYBOOK `CPYINVMS` 구조 사용. 키: 품목코드

### 출력 데이터
- **LEDGER-FILE (INVLEDG)**: 수불대장 파일 (순차 파일). COPYBOOK `CPYLEDGR` 구조 사용. 트랜잭션별 전량/후량 기록
- **TB_INV_SUMMARY**: DB2 테이블. 일일 처리 요약 (처리일자, 입고건수, 출고건수, 오류건수) INSERT

### 사용 COPYBOOK
- **CPYINVTR**: 재고 입출고 트랜잭션 레코드 (공장/품목/일자/유형/수량/단가/창고/위치/발주번호 등)
- **CPYINVMS**: 재고 마스터 레코드 (품목코드/품명/분류/단위/현재고/최소재고/최대재고/단가/상태 등)
- **CPYLEDGR**: 수불대장 레코드 (품목/일자/유형/수량/전량/후량/단가/금액)
- **SQLCA**: DB2 SQL 통신 영역
- **DCLTBINV**: DB2 재고 테이블 DCLGEN (TB_INV_SUMMARY 관련)

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 처리)
- **목적**: 프로그램의 전체 처리 흐름을 제어하는 메인 드라이버
- **처리 흐름**:
  1. 초기화 수행 (파일 오픈, 첫 레코드 읽기)
  2. 트랜잭션 파일의 EOF까지 반복하며 트랜잭션 처리
  3. 일일 처리 요약을 DB2에 저장
  4. 파일 종료 처리 및 통계 출력

### 1000-INITIALIZE (초기화)
- **목적**: 파일 오픈 및 정상 오픈 여부 확인
- **처리 흐름**:
  1. 트랜잭션 파일을 INPUT 모드로 오픈
  2. 재고 마스터 파일을 I-O (읽기/쓰기) 모드로 오픈
  3. 수불대장 파일을 OUTPUT 모드로 오픈
  4. 각 파일 상태 코드 확인 후 첫 레코드 읽기
- **에러 처리**: 트랜잭션 파일 또는 마스터 파일 오픈 실패 시 에러 메시지 출력 후 비정상 종료 (`9900-ABNORMAL-END`)
- **특이사항**: 수불대장 파일(`WS-FILE-STATUS3`)의 오픈 상태는 검사하지 않음

### 1100-READ-FIRST-RECORD (첫 레코드 읽기)
- **목적**: 트랜잭션 파일에서 첫 번째 레코드를 읽어 처리 루프 시작 준비
- **처리 흐름**: 트랜잭션 파일을 READ하고, 데이터가 없으면 EOF 플래그 설정

### 2000-PROCESS-TRANSACTION (트랜잭션 처리)
- **목적**: 개별 입출고 트랜잭션을 처리하여 재고 마스터를 갱신
- **처리 흐름**:
  1. 처리 건수 카운터 증가
  2. 트랜잭션의 품목코드로 재고 마스터를 조회 (랜덤 READ)
  3. 마스터에 해당 품목이 없으면 → 신규 품목 등록 (`2100-HANDLE-NEW-ITEM`)
  4. 마스터에 해당 품목이 있으면 → 재고 수량 갱신 (`2200-UPDATE-INVENTORY`)
  5. 수불대장에 처리 내역 기록 (`2300-WRITE-LEDGER`)
  6. 다음 트랜잭션 레코드 읽기
- **조건 분기**: INVALID KEY (품목 미존재) 여부로 신규 등록/기존 갱신 분기

### 2100-HANDLE-NEW-ITEM (신규 품목 등록)
- **목적**: 재고 마스터에 없는 품목이 입고된 경우 신규 마스터 레코드 생성
- **처리 흐름**:
  1. 마스터 레코드 초기화
  2. 트랜잭션의 품목코드, 수량, 거래일자를 마스터에 설정
  3. 마스터 파일에 WRITE
  4. 입고 카운터 증가
- **비즈니스 의미**: 처음 입고되는 품목은 자동으로 마스터에 등록됨. 품명, 분류 등 기본 정보는 초기값(공백/0)으로 설정되므로 별도 마스터 관리가 필요

### 2200-UPDATE-INVENTORY (재고 갱신)
- **목적**: 입출고 유형에 따라 재고 마스터의 현재고 수량을 증감
- **처리 흐름**:
  1. 현재 재고수량을 `WS-PREV-QTY`(전량)에 보관
  2. 트랜잭션 유형에 따라 분기 처리
  3. 최종 거래일자 갱신
  4. 마스터 레코드 REWRITE
- **조건 분기** (`EVALUATE IT-TRANS-TYPE`):
  - **'I' (입고)**: 현재고에 입고수량을 가산, 입고건수 +1
  - **'O' (출고)**: 현재고에서 출고수량을 차감, 출고건수 +1
    - 차감 후 현재고가 **음수**가 되면: `STOCKERR` 서브프로그램 호출 → 재고를 원래 수량으로 **롤백** → 오류건수 +1
  - **기타 (OTHER)**: `ERRLOG` 서브프로그램 호출 → 오류건수 +1
- **호출 서브프로그램**:
  - `STOCKERR`: 재고 부족 오류 처리 (품목코드, 부족수량 전달)
  - `ERRLOG`: 유효하지 않은 트랜잭션 유형 로깅 (유형코드, 품목코드 전달)

### 2300-WRITE-LEDGER (수불대장 기록)
- **목적**: 각 트랜잭션의 처리 결과를 수불대장에 기록
- **처리 흐름**:
  1. 수불대장 레코드 초기화
  2. 품목코드, 트랜잭션 유형, 수량, 전량(변경 전 재고), 후량(변경 후 재고), 거래일자를 설정
  3. 수불대장 파일에 WRITE
- **특이사항**: 오류가 발생한 트랜잭션도 수불대장에 기록됨 (롤백된 경우 전량=후량으로 기록)

### 3000-UPDATE-SUMMARY (일일 요약 DB2 저장)
- **목적**: 당일 처리 통계를 DB2 테이블에 INSERT
- **처리 흐름**:
  1. TB_INV_SUMMARY 테이블에 처리일자(CURRENT DATE), 입고건수, 출고건수, 오류건수 INSERT
  2. SQLCODE 확인
- **에러 처리**: SQL 에러 발생 시 `SQLERR` 서브프로그램 호출 (SQLCODE 전달)
- **호출 서브프로그램**: `SQLERR` (DB2 에러 핸들링)

### 9000-FINALIZE (종료 처리)
- **목적**: 파일 닫기 및 처리 결과 통계 출력
- **처리 흐름**:
  1. 3개 파일 모두 CLOSE
  2. 총 처리건수, 입고건수, 출고건수를 DISPLAY 출력

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오픈 실패 등 치명적 오류 시 비정상 종료 처리
- **처리 흐름**:
  1. 'PGM002 ABEND' 메시지 출력
  2. `ABNDPGM` 서브프로그램 호출 (파일 상태 코드 전달)
  3. STOP RUN으로 프로그램 즉시 종료
- **호출 서브프로그램**: `ABNDPGM` (비정상 종료 공통 처리)

## 4. 비즈니스 규칙 요약

1. **입고(I) 처리**: 트랜잭션 수량을 현재고에 가산한다
2. **출고(O) 처리**: 트랜잭션 수량을 현재고에서 차감한다
3. **재고 부족 방지**: 출고 후 현재고가 음수가 되면 해당 트랜잭션을 무효 처리하고 재고를 원래 수량으로 복원한다 (STOCKERR 호출)
4. **신규 품목 자동 등록**: 재고 마스터에 없는 품목의 트랜잭션이 들어오면 자동으로 마스터에 신규 등록한다
5. **수불대장 전량/후량 기록**: 모든 트랜잭션에 대해 변경 전 재고(전량)와 변경 후 재고(후량)를 수불대장에 기록한다
6. **유효하지 않은 트랜잭션 유형**('I', 'O' 이외)은 오류로 처리하고 ERRLOG에 기록한다
7. **일일 처리 요약**: 배치 종료 시 입고건수, 출고건수, 오류건수를 DB2 요약 테이블에 저장한다

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **재고관리** (입출고 수불 처리, 재고수량 관리, 수불대장 생성) |
| 모더나이제이션 시 주의사항 | - VSAM 파일 기반 재고 마스터를 RDBMS로 전환 시 동시성 제어(Locking) 설계 필요<br>- 재고 부족 시 롤백 로직이 단순 MOVE로 구현되어 있어, 트랜잭션 관리(COMMIT/ROLLBACK) 전환 필요<br>- `STOCKERR`, `ERRLOG`, `SQLERR`, `ABNDPGM` 4개 서브프로그램의 구현체 확인 필요<br>- 트랜잭션 유형에 'A'(조정) 코드가 88레벨로 정의되어 있으나 EVALUATE에서 처리하지 않음 → 요건 확인 필요<br>- DB2와 VSAM이 혼재된 하이브리드 구조로, 통합 트랜잭션 관리 설계 필요 |

## 6. 특이사항/리스크

- **조정(Adjustment) 미처리**: CPYINVTR에 `IT-ADJ VALUE 'A'` (재고조정)가 88레벨로 정의되어 있으나, `2200-UPDATE-INVENTORY`의 EVALUATE에서 'A' 유형을 처리하지 않아 `WHEN OTHER`로 빠져 오류 처리됨. 비즈니스 요건상 재고조정 기능이 필요하다면 로직 누락
- **수불대장 파일 상태 미검사**: `1000-INITIALIZE`에서 `WS-FILE-STATUS3` (수불대장 파일)의 오픈 상태를 검사하지 않음. 오픈 실패 시 이후 WRITE에서 런타임 에러 발생 가능
- **신규 품목 등록 시 불완전 데이터**: `2100-HANDLE-NEW-ITEM`에서 마스터 레코드를 INITIALIZE 후 품목코드/수량/일자만 설정. 품명(`IM-ITEM-NAME`), 분류(`IM-CATEGORY`), 단위(`IM-UNIT-CD`), 최소/최대 재고량 등이 공백/0으로 남아 데이터 품질 문제 발생 가능
- **DB2-VSAM 트랜잭션 불일치**: VSAM 파일 갱신과 DB2 INSERT가 별도로 수행되어, DB2 INSERT 실패 시 VSAM은 이미 갱신 완료 상태. 데이터 정합성 리스크 존재
- **단가/금액 미활용**: 트랜잭션 레코드에 `IT-UNIT-PRICE`가 있고 수불대장에 `LG-UNIT-PRICE`, `LG-AMOUNT` 필드가 있으나, `2300-WRITE-LEDGER`에서 단가와 금액을 설정하지 않음 (초기값 0으로 기록)
- **출고 롤백 후 수불대장 기록**: 재고 부족으로 출고가 롤백된 경우에도 수불대장에 기록이 남으며, 이때 전량=후량으로 기록됨. 수불대장 조회 시 무효 트랜잭션 식별 방법이 명시되지 않음