# PGM002 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM002 |
| 프로그램 목적 | 입출고 트랜잭션을 순차 처리하여 재고 마스터를 갱신하고, 수불대장(재고 이동 원장)을 생성하는 일일 배치 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | 입출고 트랜잭션 파일(INVTRAN), 재고 마스터 파일(INVMAST) |
| 주요 출력 | 갱신된 재고 마스터(INVMAST), 수불대장 파일(INVLEDG), 일일 처리 요약(TB_INV_SUMMARY 테이블) |

## 2. 데이터 흐름

### 입력 데이터
- **INV-TRANS-FILE (INVTRAN)**: 입출고 트랜잭션 VSAM KSDS 파일 (순차 읽기, 키: 공장코드+품목코드+일자+순번)
- **INV-MASTER-FILE (INVMAST)**: 재고 마스터 VSAM KSDS 파일 (랜덤 읽기/갱신, 키: 품목코드)

### 출력 데이터
- **INV-MASTER-FILE (INVMAST)**: 재고수량 갱신 (I-O 모드)
- **LEDGER-FILE (INVLEDG)**: 수불대장 순차 파일 (신규 생성)
- **TB_INV_SUMMARY**: DB2 테이블 — 일일 처리 집계(입고건수, 출고건수, 오류건수) INSERT

### 사용 COPYBOOK
- **CPYINVTR**: 입출고 트랜잭션 레코드 (공장, 품목, 일자, 유형, 수량, 단가, 창고, 위치, 거래처, 발주번호 등)
- **CPYINVMS**: 재고 마스터 레코드 (품목코드, 품명, 카테고리, 현재고, 최소/최대수량, 단가, 상태 등)
- **CPYLEDGR**: 수불대장 레코드 (품목, 일자, 유형, 수량, 변동 전/후 재고, 단가, 금액)
- **DCLTBINV**: DB2 재고 요약 테이블 DCLGEN

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 제어)
- **목적**: 프로그램 전체 흐름 제어
- **처리 흐름**:
  1. 초기화 수행 (파일 오픈, 첫 레코드 읽기)
  2. 트랜잭션 EOF까지 반복 처리
  3. 일일 처리 요약을 DB2에 저장
  4. 종료 처리 (파일 클로즈, 처리 건수 표시)

### 1000-INITIALIZE (초기화)
- **목적**: 파일 오픈 및 정상 오픈 여부 검증
- **처리 흐름**:
  1. 트랜잭션 파일을 INPUT으로 오픈
  2. 재고 마스터를 I-O(읽기/쓰기)로 오픈
  3. 수불대장 파일을 OUTPUT으로 오픈
  4. 첫 번째 트랜잭션 레코드 읽기
- **에러 처리**: 트랜잭션 파일 또는 마스터 파일 오픈 실패 시 비정상 종료(9900-ABNORMAL-END). 단, 수불대장 파일(WS-FILE-STATUS3)의 오픈 상태는 검증하지 않음 (**리스크 참조**).

### 1100-READ-FIRST-RECORD (첫 레코드 읽기)
- **목적**: 트랜잭션 파일의 첫 번째 레코드를 읽어 처리 루프 시작 준비
- **처리 흐름**: 트랜잭션 파일 READ, 레코드가 없으면 EOF 플래그 설정

### 2000-PROCESS-TRANSACTION (트랜잭션 처리)
- **목적**: 개별 입출고 트랜잭션을 처리하여 재고를 갱신하고 수불대장에 기록
- **처리 흐름**:
  1. 처리 건수 1 증가
  2. 트랜잭션의 품목코드로 재고 마스터 조회
  3. 마스터에 해당 품목이 **없으면** → 신규 품목 등록(2100)
  4. 마스터에 해당 품목이 **있으면** → 재고 갱신(2200)
  5. 수불대장 기록(2300)
  6. 다음 트랜잭션 읽기

### 2100-HANDLE-NEW-ITEM (신규 품목 등록)
- **목적**: 마스터에 존재하지 않는 품목을 신규 등록
- **처리 흐름**:
  1. 마스터 레코드 초기화
  2. 품목코드, 트랜잭션 수량(초기 재고), 거래일자 설정
  3. 마스터에 WRITE
  4. 입고 건수 1 증가
- **비즈니스 의미**: 처음 입고되는 품목을 자동으로 마스터에 등록. 트랜잭션 유형(입고/출고)에 관계없이 무조건 입고로 처리하여 등록함 (**리스크 참조**).

### 2200-UPDATE-INVENTORY (재고 갱신)
- **목적**: 기존 품목의 재고수량을 트랜잭션 유형에 따라 증감
- **처리 흐름**:
  1. 현재 재고를 변동 전 수량(WS-PREV-QTY)에 보관
  2. 트랜잭션 유형에 따라 분기:
     - **'I' (입고)**: 트랜잭션 수량을 현재고에 가산, 입고 건수 증가
     - **'O' (출고)**: 트랜잭션 수량을 현재고에서 차감, 출고 건수 증가
       - 차감 후 재고가 **음수**이면: STOCKERR 프로그램 호출(품목코드, 부족수량 전달), 재고를 원래 수량으로 복원, 오류 건수 증가
     - **기타**: ERRLOG 프로그램 호출(유형코드, 품목코드 전달), 오류 건수 증가
  3. 최종 거래일자 갱신
  4. 마스터 레코드 REWRITE
- **조건 분기**:
  - `IT-TRANS-TYPE = 'I'` → 입고 처리
  - `IT-TRANS-TYPE = 'O'` → 출고 처리 (재고 부족 시 롤백)
  - 그 외 → 에러 로그 기록
- **호출 서브프로그램**:
  - `STOCKERR`: 재고 부족 오류 처리 (품목코드, 현재고 전달)
  - `ERRLOG`: 미인식 트랜잭션 유형 오류 기록

### 2300-WRITE-LEDGER (수불대장 기록)
- **목적**: 모든 트랜잭션에 대해 수불대장(재고 이동 이력)을 기록
- **처리 흐름**:
  1. 수불대장 레코드 초기화
  2. 품목코드, 거래유형, 수량, 변동 전 재고, 변동 후 재고, 거래일자 설정
  3. 수불대장 파일에 WRITE
- **비즈니스 의미**: 오류가 발생한 트랜잭션(재고 부족, 미인식 유형)도 수불대장에 기록됨. 이는 감사 추적(audit trail) 목적으로 적절함.

### 3000-UPDATE-SUMMARY (일일 처리 요약 DB2 저장)
- **목적**: 당일 처리 결과 집계를 DB2 테이블에 기록
- **처리 흐름**:
  1. TB_INV_SUMMARY 테이블에 INSERT (처리일자=당일, 입고건수, 출고건수, 오류건수)
  2. SQLCODE 오류 시 SQLERR 프로그램 호출
- **호출 서브프로그램**: `SQLERR` — SQL 오류 처리

### 9000-FINALIZE (종료 처리)
- **목적**: 파일 클로즈 및 처리 결과 콘솔 출력
- **처리 흐름**:
  1. 트랜잭션 파일, 마스터 파일, 수불대장 파일 순서대로 CLOSE
  2. 처리건수, 입고건수, 출고건수를 콘솔에 표시

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오픈 오류 등 치명적 상황 시 비정상 종료 처리
- **처리 흐름**:
  1. 'PGM002 ABEND' 메시지 출력
  2. ABNDPGM 프로그램 호출(파일 상태코드 전달)
  3. STOP RUN으로 즉시 종료
- **호출 서브프로그램**: `ABNDPGM` — 비정상 종료 처리 프로그램

## 4. 비즈니스 규칙 요약

1. **입고 처리(I)**: 트랜잭션 수량을 현재고에 가산한다
2. **출고 처리(O)**: 트랜잭션 수량을 현재고에서 차감한다
3. **재고 부족 방지**: 출고 처리 후 재고가 음수이면 해당 출고를 취소(롤백)하고, 재고를 원래 수량으로 복원한다
4. **신규 품목 자동 등록**: 마스터에 존재하지 않는 품목이 입고되면 자동으로 마스터에 신규 등록한다
5. **미인식 유형 거부**: 입고(I)/출고(O) 외의 트랜잭션 유형은 오류 처리한다 (조정(A) 유형은 COPYBOOK에 정의되어 있으나 프로그램에서 미처리)
6. **수불대장 전건 기록**: 오류 건을 포함한 모든 트랜잭션을 수불대장에 기록한다
7. **일일 집계 DB2 저장**: 당일 입고/출고/오류 건수를 TB_INV_SUMMARY 테이블에 저장한다
8. **최종 거래일자 갱신**: 재고 마스터의 최종 거래일자를 트랜잭션 일자로 항상 갱신한다

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **재고관리** (자재 입출고, 수불관리, 재고 마스터 유지보수) |
| 모더나이제이션 시 주의사항 | ① 재고 부족 시 롤백 로직은 동시성 제어 관점에서 재설계 필요 (현재는 파일 기반 단일 처리이나, DB 기반 전환 시 트랜잭션 격리 수준 고려) ② 수불대장은 실시간 이벤트 방식으로 전환하면 추적성 향상 가능 ③ 재고 마스터의 최소/최대 수량(IM-MIN-QTY, IM-MAX-QTY) 필드가 프로그램에서 활용되지 않으므로, 모더나이제이션 시 안전재고 알림 기능 추가 검토 ④ DB2 INSERT만 수행하므로 동일 일자 재실행 시 중복 데이터 발생 가능 |

## 6. 특이사항/리스크

- **수불대장 파일 오픈 미검증**: `WS-FILE-STATUS3` (LEDGER-FILE)의 오픈 상태를 확인하지 않음. 수불대장 파일 오픈 실패 시 이후 WRITE에서 런타임 오류 발생 가능 (라인 7300~8100)
- **신규 품목 등록 시 유형 미검증**: 2100-HANDLE-NEW-ITEM에서 트랜잭션 유형을 확인하지 않고 무조건 입고 건수로 카운트함. 출고(O) 트랜잭션으로 신규 품목이 들어오면 음수 재고로 마스터가 생성될 수 있음 (라인 1030~1090)
- **조정(A) 유형 미처리**: CPYINVTR에 `IT-ADJ VALUE 'A'` (재고조정)가 정의되어 있으나, 프로그램의 EVALUATE에서 처리하지 않아 오류(WHEN OTHER)로 빠짐. 의도적 제외인지 누락인지 확인 필요 (라인 1130~1290)
- **오류 트랜잭션도 수불대장에 기록**: WHEN OTHER(미인식 유형)로 빠진 경우에도 2300-WRITE-LEDGER가 실행됨. 이때 WS-PREV-QTY에는 이전 트랜잭션의 값이 남아 있어 수불대장에 부정확한 변동 전 수량이 기록될 수 있음
- **DB2 중복 INSERT 방지 없음**: 3000-UPDATE-SUMMARY에서 동일 일자(CURRENT DATE) 중복 검사 없이 INSERT만 수행. 재실행 시 중복 행 생성 (라인 1440~1530)
- **마스터 미활용 필드**: IM-ITEM-NAME, IM-CATEGORY, IM-UNIT-CD, IM-MIN-QTY, IM-MAX-QTY, IM-UNIT-COST, IM-STATUS 필드가 프로그램에서 읽기/갱신되지 않음. 특히 IM-STATUS가 'D'(단종)인 품목에 대해서도 입출고가 그대로 처리됨
- **WS-NEW-QTY 미사용 변수**: WORKING-STORAGE에 선언되었으나 (라인 5500) 프로그램 어디에서도 사용되지 않는 데드 변수
- **오류 건수 콘솔 미출력**: 9000-FINALIZE에서 입고/출고 건수는 DISPLAY하지만 오류 건수(WS-ERROR-COUNT)는 표시하지 않음 (라인 1590~1610)
- **REWRITE 오류 미검증**: 2200-UPDATE-INVENTORY에서 마스터 REWRITE 후 파일 상태코드를 확인하지 않음 (라인 1310)