# PGM002 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM002 |
| 프로그램 목적 | 입출고 트랜잭션을 처리하여 재고 마스터를 갱신하고 수불대장(재고수불부)을 생성하는 재고수불 일일처리 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | 입출고 트랜잭션 파일(INVTRAN), 재고 마스터 파일(INVMAST) |
| 주요 출력 | 갱신된 재고 마스터 파일(INVMAST), 수불대장 파일(INVLEDG), 일일 처리 요약 DB2 테이블(TB_INV_SUMMARY) |

## 2. 데이터 흐름

### 입력 데이터
- **INVTRAN** (INV-TRANS-FILE): 입출고 트랜잭션 파일 (INDEXED, SEQUENTIAL 읽기) — COPYBOOK `CPYINVTR` 사용
- **INVMAST** (INV-MASTER-FILE): 재고 마스터 파일 (INDEXED, RANDOM 접근) — COPYBOOK `CPYINVMS` 사용

### 출력 데이터
- **INVMAST** (INV-MASTER-FILE): 갱신된 재고 마스터 (I-O 모드, 신규 WRITE 및 기존 REWRITE)
- **INVLEDG** (LEDGER-FILE): 수불대장 파일 (SEQUENTIAL, OUTPUT) — COPYBOOK `CPYLEDGR` 사용
- **TB_INV_SUMMARY**: DB2 일일 처리 요약 테이블 (INSERT)

### 사용 COPYBOOK
- **CPYINVTR**: 입출고 트랜잭션 레코드 구조 (공장코드, 품목코드, 거래일자, 순번, 거래유형, 수량, 단가, 창고, 위치, 거래처, PO번호, 사용자 등)
- **CPYINVMS**: 재고 마스터 레코드 구조 (품목코드, 품명, 분류, 단위, 현재고, 최소/최대 재고, 단가, 최종거래일, 상태 등)
- **CPYLEDGR**: 수불대장 레코드 구조 (품목코드, 거래일, 거래유형, 수량, 전재고, 현재고, 단가, 금액 등)
- **DCLTBINV**: DB2 재고 테이블 DCLGEN (TB_INV_SUMMARY용)

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 제어)
- **목적**: 전체 처리 흐름을 제어하는 메인 단락
- **처리 흐름**:
  1. 초기화 수행 (파일 열기)
  2. 트랜잭션 파일 EOF까지 반복하여 입출고 건별 처리
  3. 전체 처리 완료 후 일일 요약 정보를 DB2에 저장
  4. 종료 처리 (파일 닫기, 처리 건수 출력)

### 1000-INITIALIZE (초기화)
- **목적**: 3개 파일을 열고 정상 오픈 여부를 확인
- **처리 흐름**:
  1. 트랜잭션 파일을 INPUT으로 열기
  2. 재고 마스터 파일을 I-O(읽기/쓰기)로 열기
  3. 수불대장 파일을 OUTPUT으로 열기
  4. 첫 번째 트랜잭션 레코드를 읽기
- **에러 처리**: 트랜잭션 파일 또는 마스터 파일 오픈 실패 시 에러 메시지 출력 후 비정상 종료(9900-ABNORMAL-END)
- **주의**: 수불대장 파일(WS-FILE-STATUS3)의 오픈 상태는 검증하지 않음

### 1100-READ-FIRST-RECORD (최초 레코드 읽기)
- **목적**: 트랜잭션 파일에서 첫 번째 레코드를 읽어 처리 루프 시작 준비
- **처리 흐름**: 레코드 읽기 시도, 파일이 비어있으면 EOF 플래그 설정

### 2000-PROCESS-TRANSACTION (트랜잭션 건별 처리)
- **목적**: 개별 입출고 트랜잭션을 처리하여 재고를 갱신하고 수불대장을 기록
- **처리 흐름**:
  1. 처리 건수 카운터 1 증가
  2. 트랜잭션의 품목코드로 재고 마스터 조회
  3. 마스터에 해당 품목이 없으면 → 신규 품목 등록 (2100)
  4. 마스터에 해당 품목이 있으면 → 기존 재고 갱신 (2200)
  5. 수불대장 레코드 기록 (2300)
  6. 다음 트랜잭션 레코드 읽기

### 2100-HANDLE-NEW-ITEM (신규 품목 등록)
- **목적**: 재고 마스터에 없는 품목이 최초 입고될 때 마스터 레코드를 신규 생성
- **처리 흐름**:
  1. 마스터 레코드를 초기화
  2. 트랜잭션의 품목코드, 수량, 거래일자를 마스터에 세팅
  3. 마스터 파일에 신규 레코드 WRITE
  4. 입고 건수 카운터 1 증가
- **비즈니스 의미**: 최초 입고 시 자동으로 품목 마스터가 생성되므로, 사전 품목 등록 없이도 입고 처리가 가능한 구조

### 2200-UPDATE-INVENTORY (재고 갱신)
- **목적**: 거래 유형(입고/출고)에 따라 재고 수량을 증감하고 마스터를 갱신
- **처리 흐름**:
  1. 갱신 전 현재고(WS-PREV-QTY)를 보관 (수불대장 기록용)
  2. 거래유형별 분기 처리:
     - **'I' (입고)**: 트랜잭션 수량을 현재고에 가산, 입고 건수 증가
     - **'O' (출고)**: 트랜잭션 수량을 현재고에서 차감, 출고 건수 증가
       - 차감 후 재고가 마이너스(음수)가 되면: `STOCKERR` 서브프로그램 호출, 재고를 원래 수량으로 복원, 에러 건수 증가
     - **기타 유형**: `ERRLOG` 서브프로그램 호출, 에러 건수 증가
  3. 최종 거래일자 갱신
  4. 재고 마스터 REWRITE
- **조건 분기**: EVALUATE 문으로 거래유형(I/O/기타) 3분기 처리
- **호출 서브프로그램**:
  - `STOCKERR`: 재고 부족 에러 처리 (품목코드, 마이너스 재고량 전달)
  - `ERRLOG`: 유효하지 않은 거래유형 에러 로깅 (거래유형, 품목코드 전달)
- **핵심 비즈니스 규칙**: 출고 시 재고 부족이면 해당 출고를 취소(롤백)하고 원래 재고로 복원

### 2300-WRITE-LEDGER (수불대장 기록)
- **목적**: 트랜잭션 처리 결과를 수불대장에 기록하여 재고 이력 관리
- **처리 흐름**:
  1. 수불대장 레코드 초기화
  2. 품목코드, 거래유형, 거래수량, 전재고, 현재고, 거래일자를 세팅
  3. 수불대장 파일에 WRITE
- **비즈니스 의미**: 모든 입출고 거래의 전후 재고 변동 이력을 수불대장으로 관리

### 3000-UPDATE-SUMMARY (일일 처리 요약 DB2 저장)
- **목적**: 당일 처리 결과를 DB2 요약 테이블에 저장
- **처리 흐름**:
  1. TB_INV_SUMMARY 테이블에 당일 입고건수, 출고건수, 에러건수를 INSERT
  2. SQLCODE 확인하여 에러 시 `SQLERR` 서브프로그램 호출
- **호출 서브프로그램**: `SQLERR` — DB2 SQL 에러 처리 (SQLCODE 전달)

### 9000-FINALIZE (종료 처리)
- **목적**: 모든 파일을 닫고 처리 결과를 출력
- **처리 흐름**:
  1. 3개 파일 CLOSE
  2. 총 처리 건수, 입고 건수, 출고 건수를 DISPLAY

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오픈 에러 등 치명적 오류 시 비정상 종료
- **처리 흐름**:
  1. 'PGM002 ABEND' 메시지 출력
  2. `ABNDPGM` 서브프로그램 호출 (파일 상태 코드 전달)
  3. STOP RUN으로 프로그램 강제 종료
- **호출 서브프로그램**: `ABNDPGM` — 비정상 종료 처리 모듈

## 4. 비즈니스 규칙 요약

1. **입고(I) 처리**: 트랜잭션 수량을 현재고에 가산한다
2. **출고(O) 처리**: 트랜잭션 수량을 현재고에서 차감한다
3. **재고 부족 방지**: 출고 후 재고가 음수가 되면 해당 출고를 취소하고 원래 재고로 복원한다 (STOCKERR 호출)
4. **신규 품목 자동 등록**: 마스터에 없는 품목의 트랜잭션 발생 시 마스터를 자동 생성한다
5. **유효하지 않은 거래유형**: 'I'(입고), 'O'(출고) 이외의 거래유형은 에러로 처리한다 (ERRLOG 호출)
6. **수불대장 전수 기록**: 모든 트랜잭션(에러 포함)에 대해 전재고/현재고를 포함한 수불대장을 기록한다
7. **일일 요약 집계**: 처리 완료 후 입고/출고/에러 건수를 DB2 요약 테이블에 저장한다
8. **최종 거래일자 갱신**: 재고 갱신 시 마스터의 최종 거래일자를 해당 트랜잭션 일자로 갱신한다

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **재고관리** (입출고 처리, 재고수불, 수불대장), 부분적으로 **자재관리** (품목 마스터 자동 등록) |
| 모더나이제이션 시 주의사항 | ① VSAM INDEXED 파일 기반 마스터 관리를 RDB 기반으로 전환 필요 ② 재고 부족 시 롤백 로직을 DB 트랜잭션으로 대체 ③ 실시간 재고 반영(배치→온라인) 전환 검토 ④ STOCKERR/ERRLOG/SQLERR/ABNDPGM 서브프로그램 의존성 확인 필요 ⑤ 트랜잭션 유형 'A'(조정)가 CPYINVTR에 정의(88 IT-ADJ)되어 있으나 프로그램에서 미처리 — 향후 확장 또는 누락인지 확인 필요 |

## 6. 특이사항/리스크

- **거래유형 'A'(조정) 미처리**: COPYBOOK CPYINVTR에 88레벨 `IT-ADJ VALUE 'A'`가 정의되어 있으나, EVALUATE 문에서 'I'와 'O'만 처리하고 'A'는 OTHER(에러)로 빠짐. 재고 조정 기능이 의도적으로 제외된 것인지 누락인지 확인 필요
- **수불대장 파일 상태 미검증**: 초기화(1000-INITIALIZE)에서 WS-FILE-STATUS3(수불대장)의 오픈 상태를 검증하지 않음. 수불대장 파일 오픈 실패 시 이후 WRITE에서 런타임 에러 발생 가능
- **에러 트랜잭션도 수불대장 기록**: 재고 부족으로 롤백된 출고나 유효하지 않은 거래유형도 2300-WRITE-LEDGER에서 수불대장에 기록됨. 에러 건의 수불대장 기록이 의도된 것인지 확인 필요 (전재고=현재고로 기록되어 구분은 가능)
- **신규 품목 등록 시 불완전 데이터**: 2100-HANDLE-NEW-ITEM에서 품목코드/수량/일자만 세팅하고 품명(IM-ITEM-NAME), 분류(IM-CATEGORY), 단위(IM-UNIT-CD), 최소/최대재고, 단가 등은 초기값(공백/제로)으로 남음
- **DB2와 VSAM 혼용 구조**: 재고 마스터는 VSAM 파일, 처리 요약은 DB2 테이블로 이원화되어 있어 데이터 정합성 관리에 주의 필요
- **파일 상태 변수 공유 부재**: WS-FILE-STATUS는 트랜잭션 파일용이나, 트랜잭션 파일 읽기 후 상태 검증이 없음 (AT END만 확인)
- **신규 품목의 WS-PREV-QTY 미설정**: 2100-HANDLE-NEW-ITEM 경로에서는 WS-PREV-QTY가 설정되지 않아 수불대장의 전재고(LG-PREV-QTY)에 이전 트랜잭션의 잔여값이 기록될 수 있음