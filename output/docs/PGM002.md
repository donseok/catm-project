# PGM002 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM002 |
| 프로그램 목적 | 일일 입출고 트랜잭션을 순차 처리하여 재고 마스터를 실시간 갱신하고, 수불대장(원장)을 생성하며, 처리 결과를 DB2 요약 테이블에 기록하는 재고수불 일일처리 배치 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | 입출고 트랜잭션 파일(INVTRAN, 색인순차), 재고 마스터 파일(INVMAST, 색인랜덤) |
| 주요 출력 | 수불대장 파일(INVLEDG, 순차), DB2 테이블 TB_INV_SUMMARY |

## 2. 데이터 흐름

### 입력 데이터
- **INV-TRANS-FILE (INVTRAN)**: 입출고 트랜잭션 색인파일 — 공장코드+품목코드+일자+순번을 키로 하는 당일 입출고 내역
- **INV-MASTER-FILE (INVMAST)**: 재고 마스터 색인파일 — 품목코드별 현재고, 최소/최대 수량, 단가 등 마스터 정보

### 출력 데이터
- **LEDGER-FILE (INVLEDG)**: 수불대장 순차파일 — 트랜잭션별 전량/후량 기록 (감사추적용)
- **TB_INV_SUMMARY (DB2)**: 일일 처리요약 — 처리일자별 입고건수, 출고건수, 오류건수

### 사용 COPYBOOK
- **CPYINVTR**: 입출고 트랜잭션 레코드 구조 (공장·품목·일자·순번 키, 유형·수량·단가·창고·거래처 등)
- **CPYINVMS**: 재고 마스터 레코드 구조 (품목코드·품명·분류·현재고·최소/최대수량·단가·상태)
- **CPYLEDGR**: 수불대장 레코드 구조 (품목·일자·유형·수량·전량·후량·단가·금액)
- **DCLTBINV**: DB2 재고 요약 테이블 DCLGEN (SQL INSERT용)

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 제어)
- **목적**: 프로그램 전체 실행 흐름 제어
- **처리 흐름**:
  1. 초기화(파일 오픈) 수행
  2. 트랜잭션 파일 끝(EOF)까지 건별 처리 반복
  3. DB2 요약 테이블에 일일 처리결과 기록
  4. 파일 닫기 및 처리 통계 출력 후 종료

### 1000-INITIALIZE (초기화)
- **목적**: 3개 파일을 업무 용도에 맞게 오픈하고 정상 여부 확인
- **처리 흐름**:
  1. 트랜잭션 파일 → 입력(INPUT) 모드 오픈
  2. 재고 마스터 파일 → 입출력(I-O) 모드 오픈 (읽기+갱신)
  3. 수불대장 파일 → 출력(OUTPUT) 모드 오픈
  4. 트랜잭션 파일 오픈 실패 시 오류 메시지 출력 → 비정상 종료
  5. 마스터 파일 오픈 실패 시 오류 메시지 출력 → 비정상 종료
  6. 첫 번째 트랜잭션 레코드 읽기
- **에러 처리**: 파일 상태코드가 '00'이 아니면 즉시 비정상 종료 처리
- **주의**: 수불대장 파일(WS-FILE-STATUS3)의 오픈 상태는 검증하지 않음

### 1100-READ-FIRST-RECORD (첫 레코드 읽기)
- **목적**: 트랜잭션 파일의 첫 레코드를 읽어 처리 루프 진입 준비
- **처리 흐름**: 읽기 수행, 파일이 비어있으면 EOF 플래그 설정

### 2000-PROCESS-TRANSACTION (트랜잭션 건별 처리)
- **목적**: 입출고 트랜잭션 1건을 처리하여 재고 마스터 갱신 및 수불대장 기록
- **처리 흐름**:
  1. 처리건수 카운터 1 증가
  2. 트랜잭션의 품목코드로 재고 마스터 조회(랜덤 읽기)
  3. 마스터에 품목이 **없으면** → 신규 품목 등록 (2100)
  4. 마스터에 품목이 **있으면** → 기존 재고 갱신 (2200)
  5. 수불대장에 처리 내역 기록 (2300)
  6. 다음 트랜잭션 레코드 읽기 (EOF이면 루프 종료)

### 2100-HANDLE-NEW-ITEM (신규 품목 등록)
- **목적**: 마스터에 존재하지 않는 품목의 첫 입고 트랜잭션 처리
- **처리 흐름**:
  1. 마스터 레코드 초기화 (전 필드 공백/0)
  2. 품목코드, 트랜잭션 수량(→현재고), 거래일자(→최종일자) 설정
  3. 마스터에 신규 레코드 WRITE
  4. 입고건수 카운터 1 증가
- **비즈니스 의미**: 시스템에 등록되지 않은 품목이 최초 입고될 때 자동으로 마스터 생성

### 2200-UPDATE-INVENTORY (기존 재고 갱신)
- **목적**: 입고/출고 유형에 따라 현재고 수량을 가감하고 마스터 갱신
- **처리 흐름**:
  1. 변경 전 재고량(WS-PREV-QTY) 보관 (수불대장용)
  2. 트랜잭션 유형별 분기:
     - **'I' (입고)**: 현재고에 트랜잭션 수량 가산, 입고건수 +1
     - **'O' (출고)**: 현재고에서 트랜잭션 수량 차감, 출고건수 +1
       - 차감 후 현재고가 **음수**이면: STOCKERR 호출(재고부족 오류), 원래 수량으로 복원, 오류건수 +1
     - **기타 유형**: ERRLOG 호출(잘못된 유형 기록), 오류건수 +1
  3. 최종거래일자를 현재 트랜잭션 일자로 갱신
  4. 마스터 레코드 REWRITE
- **조건 분기**: EVALUATE로 입고(I)/출고(O)/기타를 구분하며, 출고 시 재고부족 검증 수행
- **호출 서브프로그램**:
  - `STOCKERR`: 재고부족 오류 처리 (품목코드, 부족수량 전달)
  - `ERRLOG`: 잘못된 트랜잭션 유형 로깅 (유형코드, 품목코드 전달)
- **핵심 규칙**: 출고로 인해 재고가 마이너스가 되면 해당 출고를 취소(롤백)하고 오류 처리

### 2300-WRITE-LEDGER (수불대장 기록)
- **목적**: 모든 트랜잭션의 전량/후량을 포함한 수불대장 레코드 생성
- **처리 흐름**:
  1. 수불대장 레코드 초기화
  2. 품목코드, 거래유형, 거래수량, 변경전 수량(전량), 변경후 수량(후량), 거래일자 이동
  3. 수불대장 파일에 WRITE
- **비즈니스 의미**: 재고 변동에 대한 감사추적(audit trail) 기록으로, 전량→후량 변화를 추적 가능

### 3000-UPDATE-SUMMARY (일일 처리 요약 DB2 기록)
- **목적**: 당일 처리 통계를 DB2 요약 테이블에 INSERT
- **처리 흐름**:
  1. TB_INV_SUMMARY에 처리일자(CURRENT DATE), 입고건수, 출고건수, 오류건수 INSERT
  2. SQL 오류 발생 시 SQLERR 서브프로그램 호출
- **호출 서브프로그램**: `SQLERR` — SQL 에러코드 전달하여 DB 오류 기록
- **비즈니스 의미**: 일일 재고처리 실적을 DB에 누적하여 경영보고 및 이력관리에 활용

### 9000-FINALIZE (종료 처리)
- **목적**: 모든 파일 닫기 및 처리 통계 콘솔 출력
- **처리 흐름**:
  1. 트랜잭션, 마스터, 수불대장 3개 파일 CLOSE
  2. 총 처리건수, 입고건수, 출고건수 DISPLAY

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오픈 실패 등 치명적 오류 시 프로그램 강제 종료
- **처리 흐름**: 오류 메시지 출력 → ABNDPGM 서브프로그램 호출 → STOP RUN
- **호출 서브프로그램**: `ABNDPGM` — 비정상종료 처리 (파일 상태코드 전달)

## 4. 비즈니스 규칙 요약

1. **입고(I) 처리**: 트랜잭션 수량만큼 현재고에 가산한다
2. **출고(O) 처리**: 트랜잭션 수량만큼 현재고에서 차감한다
3. **재고부족 방지**: 출고 후 현재고가 음수(0 미만)이면 해당 출고를 취소하고 원래 재고량으로 복원한다 (STOCKERR 호출)
4. **신규 품목 자동 등록**: 마스터에 없는 품목의 트랜잭션이 들어오면 자동으로 마스터 레코드를 신규 생성한다
5. **잘못된 트랜잭션 유형 거부**: 입고(I)/출고(O) 외의 유형은 오류로 처리한다 (ERRLOG 호출)
6. **수불대장 전량/후량 기록**: 모든 트랜잭션에 대해 변경 전/후 재고량을 수불대장에 기록하여 감사추적을 보장한다
7. **일일 처리 요약 DB 기록**: 당일 입고건수, 출고건수, 오류건수를 DB2 테이블에 INSERT하여 이력 관리한다
8. **최종거래일자 갱신**: 재고 마스터의 최종거래일자는 가장 마지막에 처리된 트랜잭션 일자로 갱신된다

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **재고관리** (입출고 수불처리, 재고수량 실시간 갱신, 수불대장 생성) |
| 모더나이제이션 시 주의사항 | ① 재고부족 시 출고 롤백 로직을 MES 트랜잭션 관리로 전환 필요 ② VSAM 파일 기반 마스터를 RDB 테이블로 전환 시 동시성 제어(잠금) 고려 ③ 신규 품목 자동 등록 정책의 비즈니스 타당성 재검토 (마스터 데이터 관리 관점) ④ 배치→실시간 전환 시 수불대장 기록 방식 재설계 필요 |

## 6. 특이사항/리스크

- **수불대장 파일 오픈 검증 누락**: WS-FILE-STATUS3(수불대장)의 오픈 상태를 검사하지 않아, 수불대장 파일 오픈 실패 시 무한 오류 발생 가능
- **신규 품목 등록 시 트랜잭션 유형 미검증**: 2100-HANDLE-NEW-ITEM에서 트랜잭션 유형(I/O)을 확인하지 않고 무조건 수량을 현재고로 설정한 뒤 입고건수를 증가시킴 → 출고('O') 트랜잭션이 신규 품목에 대해 발생하면 음수 재고가 마스터에 기록될 수 있음
- **재고조정(A) 유형 미지원**: CPYINVTR에 88 레벨로 IT-ADJ(VALUE 'A')가 정의되어 있으나, EVALUATE에서 'A'를 처리하지 않아 오류로 분류됨 — 재고실사 조정 기능이 설계되었으나 구현되지 않은 상태
- **REWRITE 실패 미검증**: 2200에서 마스터 REWRITE 후 파일 상태코드를 확인하지 않아, 디스크 오류 등 발생 시 조용히 실패할 수 있음
- **WRITE 실패 미검증**: 2100의 마스터 WRITE, 2300의 수불대장 WRITE 모두 상태코드 미확인
- **오류 트랜잭션도 수불대장에 기록됨**: 재고부족으로 롤백된 출고나 잘못된 유형의 트랜잭션도 2300-WRITE-LEDGER를 수행하여 수불대장에 기록됨 — 의도적 설계일 수 있으나, 오류 건의 전량/후량이 동일하게 기록되어 혼동 가능
- **DB2 INSERT 중복 가능성**: TB_INV_SUMMARY에 CURRENT DATE로 INSERT하므로, 같은 날 재실행 시 중복 행 발생 가능 (UPSERT 또는 사전 DELETE 미구현)
- **매직넘버**: 트랜잭션 유형 'I', 'O'가 소스에 하드코딩됨 (88 레벨 조건명 IT-IN, IT-OUT이 COPYBOOK에 정의되어 있으나 사용하지 않음)