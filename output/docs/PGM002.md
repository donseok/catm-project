# PGM002 - 비즈니스 로직 분석서

> 자동 생성 by CATM (Claude Code Max 20x)

## 1. 프로그램 개요

| 항목 | 내용 |
|------|------|
| 프로그램 ID | PGM002 |
| 프로그램 목적 | 입출고 트랜잭션을 순차 처리하여 재고 마스터를 실시간 갱신하고, 수불대장(원장)을 생성하는 재고수불 일일처리 프로그램 |
| 처리 유형 | 배치 |
| 주요 입력 | 입출고 트랜잭션 파일(INVTRAN, VSAM KSDS), 재고 마스터 파일(INVMAST, VSAM KSDS) |
| 주요 출력 | 갱신된 재고 마스터 파일(INVMAST), 수불대장 파일(INVLEDG, 순차), DB2 일일처리 요약 테이블(TB_INV_SUMMARY) |

## 2. 데이터 흐름

### 입력 데이터
- **INV-TRANS-FILE (INVTRAN)**: 입출고 트랜잭션 파일 — VSAM KSDS, 순차 읽기. 공장코드+품목코드+거래일자+순번을 키로 사용
- **INV-MASTER-FILE (INVMAST)**: 재고 마스터 파일 — VSAM KSDS, 랜덤 액세스(I-O 모드). 품목코드를 키로 사용

### 출력 데이터
- **INV-MASTER-FILE (INVMAST)**: 트랜잭션 반영 후 갱신된 재고 마스터 (REWRITE)
- **LEDGER-FILE (INVLEDG)**: 수불대장 — 순차 파일, 거래 건별 전후 수량 기록
- **TB_INV_SUMMARY (DB2)**: 일일처리 요약 — 처리일자, 입고건수, 출고건수, 오류건수 INSERT

### 사용 COPYBOOK
- **CPYINVTR**: 입출고 트랜잭션 레코드 (공장, 품목, 일자, 유형, 수량, 단가, 창고, 위치, 발주번호 등)
- **CPYINVMS**: 재고 마스터 레코드 (품목코드, 명칭, 카테고리, 현재수량, 최소/최대수량, 단가, 상태 등)
- **CPYLEDGR**: 수불대장 레코드 (품목, 거래유형, 수량, 변동 전/후 수량, 단가, 금액)
- **DCLTBINV**: DB2 재고 요약 테이블 DCLGEN (SQLCA 포함)

## 3. 비즈니스 로직 상세

### 0000-MAIN-PROCESS (메인 제어)
- **목적**: 프로그램 전체 흐름을 제어하는 최상위 단락
- **처리 흐름**:
  1. 초기화 수행 (파일 오픈, 첫 레코드 읽기)
  2. 트랜잭션 파일 EOF까지 건별 처리 반복
  3. DB2에 일일처리 요약 기록
  4. 파일 종료 및 결과 출력

### 1000-INITIALIZE (초기화)
- **목적**: 3개 파일을 각각의 용도에 맞게 오픈하고 정상 여부를 확인
- **처리 흐름**:
  1. 트랜잭션 파일을 INPUT으로 오픈
  2. 재고 마스터를 I-O(읽기/갱신)로 오픈
  3. 수불대장을 OUTPUT으로 오픈
  4. 파일 상태 코드 점검 후 오류 시 비정상 종료
  5. 첫 번째 트랜잭션 레코드 읽기
- **에러 처리**: 트랜잭션 파일 또는 마스터 파일 오픈 실패 시 에러 메시지 출력 후 `9900-ABNORMAL-END` 호출

### 1100-READ-FIRST-RECORD (최초 레코드 읽기)
- **목적**: 트랜잭션 파일의 첫 레코드를 읽어 처리 루프 진입 준비
- **처리 흐름**: 트랜잭션 파일 READ, 데이터 없으면 EOF 플래그 설정

### 2000-PROCESS-TRANSACTION (트랜잭션 처리 — 핵심 로직)
- **목적**: 개별 입출고 트랜잭션을 재고 마스터에 반영하고 수불대장에 기록
- **처리 흐름**:
  1. 처리건수 카운터 증가
  2. 트랜잭션의 품목코드로 재고 마스터 조회 (READ by key)
  3. 마스터에 품목이 **없으면** → 신규 품목 등록 (`2100-HANDLE-NEW-ITEM`)
  4. 마스터에 품목이 **있으면** → 재고 수량 갱신 (`2200-UPDATE-INVENTORY`)
  5. 수불대장 기록 (`2300-WRITE-LEDGER`)
  6. 다음 트랜잭션 레코드 읽기
- **조건 분기**: INVALID KEY 여부로 신규/기존 품목 분기

### 2100-HANDLE-NEW-ITEM (신규 품목 등록)
- **목적**: 마스터에 없는 품목이 입고된 경우 신규 마스터 레코드를 생성
- **처리 흐름**:
  1. 마스터 레코드 초기화
  2. 트랜잭션의 품목코드, 수량, 거래일자를 마스터에 설정
  3. 마스터 파일에 WRITE (신규 등록)
  4. 입고건수 카운터 증가

### 2200-UPDATE-INVENTORY (재고 갱신 — 핵심 비즈니스 규칙)
- **목적**: 트랜잭션 유형(입고/출고)에 따라 재고 수량을 증감하고, 이상 상황을 처리
- **처리 흐름**:
  1. 현재 재고수량을 `WS-PREV-QTY`(변동 전 수량)에 보관
  2. 트랜잭션 유형별 분기:
     - **'I' (입고)**: 트랜잭션 수량을 현재 재고에 가산, 입고건수 증가
     - **'O' (출고)**: 트랜잭션 수량을 현재 재고에서 차감, 출고건수 증가
       - 차감 후 재고가 **음수**가 되면: `STOCKERR` 서브프로그램 호출 → 재고를 변동 전 수량으로 복원 → 오류건수 증가
     - **기타 유형**: `ERRLOG` 서브프로그램 호출 → 오류건수 증가
  3. 마스터의 최종거래일자를 트랜잭션 일자로 갱신
  4. 마스터 레코드 REWRITE
- **조건 분기**:
  - `EVALUATE IT-TRANS-TYPE`: 입고('I') / 출고('O') / 기타로 분기
  - 출고 시 음수 재고 방지 검증
- **호출 서브프로그램**:
  - `STOCKERR`: 재고 부족 오류 처리 (품목코드, 음수수량 전달)
  - `ERRLOG`: 미정의 트랜잭션 유형 오류 로깅 (유형코드, 품목코드 전달)

### 2300-WRITE-LEDGER (수불대장 기록)
- **목적**: 매 트랜잭션마다 변동 전후 수량을 포함한 수불대장 레코드를 생성
- **처리 흐름**:
  1. 수불대장 레코드 초기화
  2. 품목코드, 거래유형, 거래수량, 변동 전 수량, 변동 후 수량, 거래일자를 설정
  3. 수불대장 파일에 WRITE

### 3000-UPDATE-SUMMARY (일일처리 요약 DB2 기록)
- **목적**: 당일 처리 결과(입고/출고/오류 건수)를 DB2 요약 테이블에 저장
- **처리 흐름**:
  1. `TB_INV_SUMMARY` 테이블에 INSERT (처리일자=CURRENT DATE, 입고건수, 출고건수, 오류건수)
  2. SQLCODE 확인 → 0이 아니면 `SQLERR` 서브프로그램 호출
- **호출 서브프로그램**: `SQLERR` — DB2 SQL 오류 처리 (SQLCODE 전달)

### 9000-FINALIZE (종료 처리)
- **목적**: 파일 정리 및 처리 결과 출력
- **처리 흐름**:
  1. 3개 파일 모두 CLOSE
  2. 총 처리건수, 입고건수, 출고건수를 DISPLAY

### 9900-ABNORMAL-END (비정상 종료)
- **목적**: 파일 오픈 실패 등 치명적 오류 발생 시 프로그램 강제 종료
- **처리 흐름**:
  1. 'PGM002 ABEND' 메시지 출력
  2. `ABNDPGM` 서브프로그램 호출 (파일 상태 코드 전달)
  3. STOP RUN

## 4. 비즈니스 규칙 요약

1. **입고 처리('I')**: 트랜잭션 수량을 현재 재고에 가산한다
2. **출고 처리('O')**: 트랜잭션 수량을 현재 재고에서 차감한다
3. **재고 음수 방지**: 출고 후 재고가 음수가 되면 해당 출고를 취소(롤백)하고 오류 처리한다
4. **미정의 트랜잭션 거부**: 'I', 'O' 이외의 트랜잭션 유형은 오류로 기록한다
5. **신규 품목 자동 등록**: 마스터에 없는 품목이 트랜잭션에 등장하면 자동으로 마스터에 신규 등록한다
6. **수불대장 필수 기록**: 모든 트랜잭션(오류 포함)에 대해 변동 전/후 수량을 포함한 수불대장을 기록한다
7. **일일 요약 저장**: 당일 입고/출고/오류 건수를 DB2 테이블에 집계 저장한다

## 5. MES 관련도 평가

| 항목 | 평가 |
|------|------|
| MES 직접 관련 여부 | **높음** |
| 관련 MES 기능 | **재고관리** (입출고 수불처리, 재고수량 실시간 관리, 수불대장 생성) |
| 모더나이제이션 시 주의사항 | (1) 재고 음수 방지 로직(롤백 패턴)을 신규 시스템에서 트랜잭션 단위로 재현해야 함 (2) 신규 품목 자동 등록 정책이 현행 업무에 적합한지 재검토 필요 — 현재는 품목명·카테고리·단위 등 마스터 핵심 정보 없이 등록됨 (3) 수불대장의 변동 전/후 수량 기록 패턴은 감사추적(Audit Trail)에 해당하므로 이력 관리 체계로 전환 필요 (4) DB2 요약 INSERT와 VSAM 파일 갱신이 별도 커밋 단위이므로 장애 시 데이터 정합성 불일치 위험 |

## 6. 특이사항/리스크

- **COPYBOOK 필드 미활용**: 트랜잭션의 `IT-UNIT-PRICE`, `IT-WAREHOUSE-CD`, `IT-LOCATION-CD`, `IT-VENDOR-CD`, `IT-PO-NO`, `IT-USER-ID` 등 다수 필드가 프로그램에서 사용되지 않음. 수불대장의 `LG-UNIT-PRICE`, `LG-AMOUNT` 필드도 기록되지 않아 금액 산출이 누락됨
- **신규 품목 등록 시 불완전 마스터**: `2100-HANDLE-NEW-ITEM`에서 품목코드, 수량, 일자만 설정하고 `IM-ITEM-NAME`, `IM-CATEGORY`, `IM-UNIT-CD`, `IM-STATUS` 등은 INITIALIZE 기본값(공백/제로)으로 남음
- **조정('A') 트랜잭션 미처리**: CPYINVTR에 `IT-ADJ VALUE 'A'`(재고 조정)가 정의되어 있으나, 프로그램은 'I'/'O'만 처리하고 'A'는 오류(WHEN OTHER)로 분류함
- **WS-FILE-STATUS3 미검증**: 수불대장 파일(LEDGER-FILE)의 오픈 상태를 검증하지 않아 오픈 실패 시 무응답 오류 가능
- **오류 트랜잭션도 수불대장에 기록**: 출고 실패(음수 재고)나 미정의 유형 오류 시에도 `2300-WRITE-LEDGER`가 호출되어 수불대장에 기록됨. 의도적 설계인지 확인 필요
- **DB2-VSAM 트랜잭션 불일치**: `3000-UPDATE-SUMMARY`의 DB2 INSERT 실패 시 `SQLERR`만 호출하고 프로그램은 정상 종료. VSAM 파일 변경은 이미 완료된 상태이므로 DB2 장애 시 요약 데이터 누락 위험
- **WS-NEW-QTY 미사용 변수**: WORKING-STORAGE에 선언된 `WS-NEW-QTY`가 어디에서도 사용되지 않는 데드코드